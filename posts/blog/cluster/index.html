<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=theme-color content="#494f5c"><meta name=msapplication-TileColor content="#494f5c"><meta itemprop=name content="Selfhosted RaspberryPI based Docker Swarm Cluster"><meta itemprop=description content="Introduction I am renting virtual servers for a long time now to host different personal projects, including this website. I tried all of them: AWS, Google Cloud, DigitalOcean , Azure, and I was entirely satisfied with them until two weeks ago. Two weeks ago I came across the [article](https://medium.com/@bossjones/how-i-setup-a-raspberry -pi-3-cluster-using-the-new-docker-swarm-mode-in-29-minutes-aa0e4f3b1768) where the guy described how easy is to set up a RaspberryPI cluster powered by Docker Swarm. This idea seemed exciting to me, so I ordered all the equipment and spent some time to set it up and move most of the services from DigitalOcean servers to my living room."><meta itemprop=datePublished content="2018-11-02T00:00:00+00:00"><meta itemprop=dateModified content="2018-11-02T00:00:00+00:00"><meta itemprop=wordCount content="1087"><meta itemprop=keywords content="raspberry pi,docker swarm,"><meta property="og:title" content="Selfhosted RaspberryPI based Docker Swarm Cluster"><meta property="og:description" content="Introduction I am renting virtual servers for a long time now to host different personal projects, including this website. I tried all of them: AWS, Google Cloud, DigitalOcean , Azure, and I was entirely satisfied with them until two weeks ago. Two weeks ago I came across the [article](https://medium.com/@bossjones/how-i-setup-a-raspberry -pi-3-cluster-using-the-new-docker-swarm-mode-in-29-minutes-aa0e4f3b1768) where the guy described how easy is to set up a RaspberryPI cluster powered by Docker Swarm. This idea seemed exciting to me, so I ordered all the equipment and spent some time to set it up and move most of the services from DigitalOcean servers to my living room."><meta property="og:type" content="article"><meta property="og:url" content="https://galaiko.rocks/posts/blog/cluster/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2018-11-02T00:00:00+00:00"><meta property="article:modified_time" content="2018-11-02T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Selfhosted RaspberryPI based Docker Swarm Cluster"><meta name=twitter:description content="Introduction I am renting virtual servers for a long time now to host different personal projects, including this website. I tried all of them: AWS, Google Cloud, DigitalOcean , Azure, and I was entirely satisfied with them until two weeks ago. Two weeks ago I came across the [article](https://medium.com/@bossjones/how-i-setup-a-raspberry -pi-3-cluster-using-the-new-docker-swarm-mode-in-29-minutes-aa0e4f3b1768) where the guy described how easy is to set up a RaspberryPI cluster powered by Docker Swarm. This idea seemed exciting to me, so I ordered all the equipment and spent some time to set it up and move most of the services from DigitalOcean servers to my living room."><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color><link rel="shortcut icon" href=/favicon.ico><title>Selfhosted RaspberryPI based Docker Swarm Cluster</title><link rel=stylesheet href=https://galaiko.rocks/css/style.min.037b6ee8f8c1baab6a3d0a9da11c3ff18a7552471f16c59fd98538d5ce99208b.css integrity="sha256-A3tu6PjBuqtqPQqdoRw/8Yp1UkcfFsWf2YU41c6ZIIs=" crossorigin=anonymous></head><body id=page><header id=site-header class="animated slideInUp"><div class="hdr-wrapper section-inner"><div class=hdr-left><div class=site-branding><a href=https://galaiko.rocks>Nikita Galaiko</a></div><nav class="site-nav hide-in-mobile"><a href=https://galaiko.rocks/posts/>Posts</a>
<a href=https://galaiko.rocks/about/>About</a></nav></div><div class="hdr-right hdr-icons"><span class="hdr-social hide-in-mobile"><a href=https://github.com/ngalaiko target=_blank rel="noopener me" title=Github><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a><a href=mailto:nikita+blog@galaiko.rocks target=_blank rel="noopener me" title=Email><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1.0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1.0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg></a><a href=/keys/nikita-at-galaiko-rocks.asc target=_blank rel="noopener me" title=Pgp><svg xmlns="http://www.w3.org/2000/svg" class="feather feather-link" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71"/></svg></a></span><button id=menu-btn class=hdr-btn title=Menu><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button></div></div></header><div id=mobile-menu class="animated fast"><ul><li><a href=https://galaiko.rocks/posts/>Posts</a></li><li><a href=https://galaiko.rocks/about/>About</a></li></ul></div><main class="site-main section-inner animated fadeIn faster"><article class=thin><header class=post-header><div class=post-meta><span>Nov 2, 2018</span></div><h1>Selfhosted RaspberryPI based Docker Swarm Cluster</h1></header><div class=content><h2 id=introduction>Introduction<a href=#introduction class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><p>I am renting virtual servers for a long time now to host different personal
projects, including this website. I tried all of them: AWS, Google Cloud, DigitalOcean
, Azure, and I was entirely satisfied with them until two weeks ago. Two weeks
ago I came across the [article](<a href=https://medium.com/@bossjones/how-i-setup-a-raspberry>https://medium.com/@bossjones/how-i-setup-a-raspberry</a>
-pi-3-cluster-using-the-new-docker-swarm-mode-in-29-minutes-aa0e4f3b1768) where
the guy described how easy is to set up a RaspberryPI cluster powered by
Docker Swarm. This idea seemed exciting to me, so I ordered all the equipment
and spent some time to set it up and move most of the services from
DigitalOcean servers to my living room. During that time I faced a lot of
unexpected difficulties and read most of the articles where people described
how to set up the Docker Swarm cluster, but none of them completely covered everything I wanted to do, so here is another one.</p><p>Hardware Used:</p><ul><li>4 x <a href="https://www.amazon.de/gp/product/B06XFSZGCC/ref=oh_aui_detailpage_o00_s00?ie=UTF8&psc=1">microSDHC 32 Pro Class 10</a></li><li>4 x <a href="https://www.amazon.de/gp/product/B07F71BWZT/ref=oh_aui_detailpage_o00_s00?ie=UTF8&psc=1">Layer case for Raspberry Pi</a></li><li>4 x <a href="https://www.amazon.de/gp/product/B01A7BVDES/ref=oh_aui_detailpage_o00_s01?ie=UTF8&psc=1">microUSB cable</a></li><li>5 x <a href="https://www.amazon.de/gp/product/B0046ZAK0K/ref=oh_aui_detailpage_o00_s01?ie=UTF8&psc=1">Gigabit Ethernet patch cable</a></li><li>1 x <a href="https://www.amazon.de/gp/product/B00PTLSH9G/ref=oh_aui_detailpage_o00_s02?ie=UTF8&psc=1">USB Charger for 6 ports</a></li><li>4 x <a href="https://www.amazon.de/gp/product/B07BFH96M3/ref=oh_aui_detailpage_o00_s02?ie=UTF8&psc=1">Raspberry PI 3 Model B+</a></li><li>1 x <a href="https://www.amazon.de/gp/product/B000BCC0LO/ref=oh_aui_detailpage_o00_s02?ie=UTF8&psc=1">8-Port Gigabit Switch</a></li></ul><p><img src=/media/cluster.jpg alt=Cluster></p><p>Technologies used:</p><ul><li>HypriotOS - operating system for Raspberry Pi with preinstalled docker</li><li>Docker Swarm - container orcestrator</li><li>Minio - s3 compatible object storage</li><li>rexray/s3fs - docker volume driver for s3 system</li><li>s3fs (v1.8.4) - itself</li><li>Prometheus / Grafana - for monitoring</li><li>Traefik - reverse proxy and load balancer</li></ul><h2 id=software>Software<a href=#software class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><h3 id=arm>ARM<a href=#arm class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h3><p>First of all, you should be aware that ARM architecture that Raspberry PI is
based on is a pain in the ass. Almost none of Docker images that you find are
going to work as you would expect, so that be ready to rewrite docker files and recompile binaries.
What really helps here is the <code>--resolve-image never</code> flag for deployment. Because
sometimes even if the image uses ARM compatible architecture, docker think
that it&rsquo;s amd64. You can find an example of a simple deployment script <a href=./scripts/deploy_arm32v7.sh>here</a>
Here is the list of images I found good as a base:</p><ul><li><a href=https://hub.docker.com/r/apcheamitru/arm32v7-alpine/>apcheamitru/arm32v7-alpine</a> - for alpine based images. Use this one when possible, it&rsquo;s much smaller.</li><li><a href=https://hub.docker.com/r/arm32v7/debian/>arm32v7/debian:7.11-slim</a> - for Debian based images and when you are can&rsquo;t/lazy to use alpine.</li></ul><h3 id=docker-swarm>Docker Swarm<a href=#docker-swarm class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h3><p>Initially, I planned to use Kubernates for the cluster orchestrator, but
change that for Docker Swarm, because it turns out much more straightforward
to set up. However, it has some disadvantages according to DevOps experts on
the Internet, one that I found is that if you want to have shared storage for
your volumes across the cluster, you are going to waste a week to find a solution
that works on ARM and it will just cause more problems, because it&rsquo;s super slow.</p><h3 id=traefik>Traefik<a href=#traefik class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h3><p>For routing inside of the cluster, I use Traefik - a modern reverse proxy. What
I liked about it has an integration with the docker API, so you don&rsquo;t need to
describe all of your routes in a configuration file, you just put all
containers in the same network and label them in the same compose file where
you describe the container.</p><h3 id=prometheus-grafana>Prometheus, Grafana<a href=#prometheus-grafana class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h3><p>The first thing you want to do after you have a working cluster is monitoring, so
you know how much resources are in use and what&rsquo;s the best way to distribute
them across the cluster.</p><p>As a source of data for the dashboards I use:</p><ul><li>node-exporter
This provides the necessary node information like overall usage of RAM / SPU / SSD
, disk read/write rate, network activity, etc.</li><li>arm-exporter
I use this to have information about Pi&rsquo;s temperature. It has a strict
correlation with CPU usage, but you want to make sure it&rsquo;s never higher than 50C.</li><li>cadvisor
It provides information from containers point of view. How much of the
allocated resources are in use by a service. For example, I have a limit of
256MB of RAM for Prometheus, so it goes down every day or so because OOM
killer restarts it once the RAM usage crosses the limit. Thanks to this
exporter I am aware of this and can increase the limit or do nothing (I do nothing)</li></ul><h3 id=minio>Minio<a href=#minio class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h3><p>After I configured the basic cluster, I faced a serious problem. Every time I update
the cluster, and Docker Swarm decides to move a service to another node, your
persistent data is lost, because by default Swarm supports only local volumes, it
means that volume is mounter to the current node and you have to bother
yourself syncing it between multiple nodes if you need to.</p><p>To have a shared volume, I have chosen <a href=https://minio.io/>Minio</a> cluster and <a href=https://rexray.io/>rexray</a> as an s3fs volume driver.
<a href=https://github.com/s3fs-fuse/s3fs-fuse>s3fs</a> is a file system from Amazon
that allows you to mount a bucket from s3 to the disk and store data there.
Rexray allows you to use s3fs to create volumes. However, since I wanted to go
full self-hosted, Amazon is not an option. That&rsquo;s why I use minio since it
has fully compatible API with Amazon&rsquo;s s3.
To configure all of that I had to build the Minio image because the one in
their docker registry is one year old and didn&rsquo;t work because it wasn&rsquo;t fully
UNIX compatible (mkdir didn&rsquo;t work). To make it work, you need an s3fs version
higher than 1.82, and latest fuse version that you need to compile yourself. Also
, you need a rexray plugin built for the ARM platform.
You can find all of the images in <a href=https://hub.docker.com/u/ngalayko/>my docker hub</a>.
However, I should warn you that when you manage to set this up, you find out
that write speed is extremely slow and the solution for persistence is to bind
a service to a node using placement constraints.</p><h2 id=migration>Migration<a href=#migration class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><p>I used to deploy all services using docker compose. You can read about it <a href=https://galaiko.rocks/posts/docker-compose-server-manegement/>here</a>.
The first step was to rewrite all compose files to version 3, so I can reuse
them for Swarm deployment.
The second step is to set up a cluster and expose it to the Internet.
To avoid downtime, I created a test domain that was a base domain for all
cluster services while I was testing it.
When cluster was ready for &ldquo;production&rdquo;, I changed DNS settings and pointer
the real domain to cluster IP, so after DNS cache was updated, all users were
migrated to the new cluster without noticing (let&rsquo;s pretend I have more than
20 daily visitors and they care about this blog).</p><p>Next plans are to set up DNS over HTTPS and VPN over HTTPS on the same cluster.</p><h2 id=links>Links<a href=#links class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><ul><li><a href=https://github.com/ngalayko/server>github repo</a></li></ul></div><hr class=post-end><footer class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=tag><a href=https://galaiko.rocks/tags/raspberry-pi>raspberry pi</a></span><span class=tag><a href=https://galaiko.rocks/tags/docker-swarm>docker swarm</a></span></p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>1087 Words</p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>2018-11-02 00:00 +0000</p></footer></article><div class="post-nav thin"><a class=next-post href=https://galaiko.rocks/posts/blog/optimizing-functions/><span class=post-nav-label><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>&nbsp;Newer</span><br><span>Optimizing a function</span></a>
<a class=prev-post href=https://galaiko.rocks/posts/dcp/maze/><span class=post-nav-label>Older&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg></span><br><span>Daily Coding Problem #23</span></a></div><div id=comments class=thin></div></main><footer id=site-footer class="section-inner thin animated fadeIn faster"><p>&copy; 2021 <a href=https://galaiko.rocks>Nikita Galaiko</a> &#183; <a href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank rel=noopener>CC BY-NC 4.0</a></p><p>Made with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> &#183; Theme <a href=https://github.com/Track3/hermit target=_blank rel=noopener>Hermit</a> &#183; <a href=https://galaiko.rocks/posts/index.xml target=_blank title=rss><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></p></footer><script src=https://galaiko.rocks/js/bundle.min.7d8545daa55d62427355498dd8da13f98ff79a7938ce7d2a5e2ae1ec0de3beb8.js integrity="sha256-fYVF2qVdYkJzVUmN2NoT+Y/3mnk4zn0qXirh7A3jvrg=" crossorigin=anonymous></script></body></html>
<!doctype html><html><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Nikita Galaiko"><title>Selfhosted RaspberryPI based Docker Swarm Cluster</title><link rel="shortcut icon" href=https://galaiko.rocks/favicon.ico><style>*,*:before,*:after{box-sizing:border-box}html{font-size:62.5%}body{font-size:16px;font-size:1.6rem;font-family:helvetica neue,arial,sans-serif;color:#313a3d;width:100%;margin:0 auto;padding:0 16px;line-height:1.6}header#banner{margin:25px 0}header#banner a{color:#313a3d;text-decoration:none}header#banner a:hover{text-decoration:underline}header#banner h2{display:inline;font-size:21px;font-size:2.1rem;margin:0 8px 0 0}header#banner nav{display:inline-block}header#banner nav ul{list-style-type:none;font-size:1.05em;text-transform:lowercase;margin:0;padding:0}header#banner nav ul li{display:inline;margin:0 3px}header#banner nav ul li a{color:#454545}main#content a{color:#007dfa;text-decoration:none}main#content a:hover{text-decoration:underline}main#content h1,main#content h2,main#content h3,main#content h4,main#content h5,main#content h6{margin-bottom:0;line-height:1.15}main#content h3{font-size:19px;font-size:1.9rem}main#content h1+p,main#content h2+p,main#content h3+p,main#content h4+p,main#content h5+p,main#content h6+p{margin-top:5px}main#content p{color:#394548;margin:16px 0}main#content hr{height:1px;border:0;background:#d8d8d8}main#content ul#posts{list-style-type:none;font-size:16px;font-size:1.6rem;margin-top:0;padding:0}main#content ul#posts li{margin:5px 0;padding:0}main#content ul#posts small{font-size:.8em;color:#767676;margin-left:10px}main#content ul#posts li a{text-decoration:none}main#content ul#posts li a:hover{color:#369aff}main#content ul#posts li a:hover small{color:inherit}main#content header#post-header h1{display:block;font-size:23px;font-size:2.3rem;line-height:1.15}main#content header#post-header div{display:block;font-size:.85em;color:#767676}main#content #toc{border:1px solid #b1b1b1;border-radius:1px;line-height:26px;margin:16px 0;padding:9px 14px}main#content #toc h4{font-size:1.06em;color:#3d3d3d;margin:0}main#content #toc nav#TableOfContents{margin-top:4px}main#content #toc nav#TableOfContents>ul,main#content #toc nav#TableOfContents>ol{margin-left:-40px}main#content #toc ul,main#content #toc ol{font-size:.98em;margin:0;padding:0 0 0 40px}main#content #toc ul{list-style-type:none}main#content #toc ol{counter-reset:item}main#content #toc ol li{display:block}main#content #toc ol li:before{content:counters(item,".")". ";counter-increment:item}main#content img{max-width:100%;margin:0 auto}main#content figure{margin:16px 0}main#content figure img{display:block;max-width:100%;margin:0 auto}main#content figure figcaption{font-size:.92em;font-style:italic;line-height:22px;text-align:center;margin-top:6px;padding:0 10px}main#content figure figcaption h4{font-style:normal;display:inline;margin:0}main#content figure figcaption p{display:inline;margin:0;padding-left:8px}main#content blockquote{font-style:italic;margin-top:10px;margin-bottom:10px;margin-left:50px;padding-left:15px;border-left:3px solid #ccc}main#content code,main#content pre{font-family:menlo,monospace}main#content code{font-size:.96em;padding:0 5px}main#content pre{display:block;overflow-x:auto;font-size:14px;font-size:1.4rem;white-space:pre;margin:20px 0;padding:1.5rem;line-height:1.4}main#content pre code{padding:0}main#content section.footnotes{font-size:.9em}footer#footer{font-size:14px;font-size:1.4rem;font-weight:300;color:#949494;margin:40px 0}html{scrollbar-color:#6c6c6c #2e2e2e}body{color:#282828;background:#fbf1c7}header#banner a{color:#282828;text-decoration:none}header#banner nav ul li a{color:#504945}main#content a{color:#076678}main#content p{color:#3c3836}main#content hr{background:#d8d8d8}main#content #toc h4{color:#3d3d3d}main#content ul#posts small{color:#7c6f64}main#content ul#posts li a:hover{color:#458588}main#content header#post-header div{color:#7c6f64}@media(min-width:770px){body{width:600px;line-height:1.5}main#content hr{width:108%;margin-left:-3.8%}header#banner h2{font-size:25px;font-size:2.5rem}main#content h3{font-size:20px;font-size:2rem}main#content ul#posts{font-size:18px;font-size:1.8rem}main#content header#post-header h1{font-size:26px;font-size:2.6rem}main#content img{max-width:108%;margin-left:-3.8%}main#content figure{margin-left:-3.8%}main#content figure img{max-width:108%}main#content pre{width:108%;margin-left:-3.8%;padding:1.5rem 2.2rem}}@media(prefers-color-scheme:dark){html{scrollbar-color:#6c6c6c #2e2e2e}body{color:#fbf1c7;background:#282828}header#banner a{color:#fbf1c7;text-decoration:none}header#banner nav ul li a{color:#d5c4a1}main#content a{color:#83a598}main#content p{color:#ebdbb2}main#content hr{background:#5c5c5c}main#content #toc h4{color:#d4d4d4}main#content ul#posts small{color:#a89984}main#content ul#posts li a:hover{color:#458588}main#content header#post-header div{color:#a89984}}</style></head><body><header id=banner><h2><a href=https://galaiko.rocks>Nikita Galaiko</a></h2><nav><ul><li><a href=/posts/ title>Posts</a></li><li><a href=/about/ title>About</a></li><li><a href=/posts/index.xml title>RSS</a></li></ul></nav></header><main id=content><article><header id=post-header><h1>Selfhosted RaspberryPI based Docker Swarm Cluster</h1><div><time>November 2, 2018</time></div></header><h2 id=introduction>Introduction</h2><p>I am renting virtual servers for a long time now to host different personal
projects, including this website. I tried all of them: AWS, Google Cloud, DigitalOcean
, Azure, and I was entirely satisfied with them until two weeks ago. Two weeks
ago I came across the [article](<a href=https://medium.com/@bossjones/how-i-setup-a-raspberry>https://medium.com/@bossjones/how-i-setup-a-raspberry</a>
-pi-3-cluster-using-the-new-docker-swarm-mode-in-29-minutes-aa0e4f3b1768) where
the guy described how easy is to set up a RaspberryPI cluster powered by
Docker Swarm. This idea seemed exciting to me, so I ordered all the equipment
and spent some time to set it up and move most of the services from
DigitalOcean servers to my living room. During that time I faced a lot of
unexpected difficulties and read most of the articles where people described
how to set up the Docker Swarm cluster, but none of them completely covered everything I wanted to do, so here is another one.</p><p>Hardware Used:</p><ul><li>4 x <a href="https://www.amazon.de/gp/product/B06XFSZGCC/ref=oh_aui_detailpage_o00_s00?ie=UTF8&psc=1">microSDHC 32 Pro Class 10</a></li><li>4 x <a href="https://www.amazon.de/gp/product/B07F71BWZT/ref=oh_aui_detailpage_o00_s00?ie=UTF8&psc=1">Layer case for Raspberry Pi</a></li><li>4 x <a href="https://www.amazon.de/gp/product/B01A7BVDES/ref=oh_aui_detailpage_o00_s01?ie=UTF8&psc=1">microUSB cable</a></li><li>5 x <a href="https://www.amazon.de/gp/product/B0046ZAK0K/ref=oh_aui_detailpage_o00_s01?ie=UTF8&psc=1">Gigabit Ethernet patch cable</a></li><li>1 x <a href="https://www.amazon.de/gp/product/B00PTLSH9G/ref=oh_aui_detailpage_o00_s02?ie=UTF8&psc=1">USB Charger for 6 ports</a></li><li>4 x <a href="https://www.amazon.de/gp/product/B07BFH96M3/ref=oh_aui_detailpage_o00_s02?ie=UTF8&psc=1">Raspberry PI 3 Model B+</a></li><li>1 x <a href="https://www.amazon.de/gp/product/B000BCC0LO/ref=oh_aui_detailpage_o00_s02?ie=UTF8&psc=1">8-Port Gigabit Switch</a></li></ul><p><img src=/media/cluster.jpg alt=Cluster></p><p>Technologies used:</p><ul><li>HypriotOS - operating system for Raspberry Pi with preinstalled docker</li><li>Docker Swarm - container orcestrator</li><li>Minio - s3 compatible object storage</li><li>rexray/s3fs - docker volume driver for s3 system</li><li>s3fs (v1.8.4) - itself</li><li>Prometheus / Grafana - for monitoring</li><li>Traefik - reverse proxy and load balancer</li></ul><h2 id=software>Software</h2><h3 id=arm>ARM</h3><p>First of all, you should be aware that ARM architecture that Raspberry PI is
based on is a pain in the ass. Almost none of Docker images that you find are
going to work as you would expect, so that be ready to rewrite docker files and recompile binaries.
What really helps here is the <code>--resolve-image never</code> flag for deployment. Because
sometimes even if the image uses ARM compatible architecture, docker think
that it&rsquo;s amd64. You can find an example of a simple deployment script <a href=./scripts/deploy_arm32v7.sh>here</a>
Here is the list of images I found good as a base:</p><ul><li><a href=https://hub.docker.com/r/apcheamitru/arm32v7-alpine/>apcheamitru/arm32v7-alpine</a> - for alpine based images. Use this one when possible, it&rsquo;s much smaller.</li><li><a href=https://hub.docker.com/r/arm32v7/debian/>arm32v7/debian:7.11-slim</a> - for Debian based images and when you are can&rsquo;t/lazy to use alpine.</li></ul><h3 id=docker-swarm>Docker Swarm</h3><p>Initially, I planned to use Kubernates for the cluster orchestrator, but
change that for Docker Swarm, because it turns out much more straightforward
to set up. However, it has some disadvantages according to DevOps experts on
the Internet, one that I found is that if you want to have shared storage for
your volumes across the cluster, you are going to waste a week to find a solution
that works on ARM and it will just cause more problems, because it&rsquo;s super slow.</p><h3 id=traefik>Traefik</h3><p>For routing inside of the cluster, I use Traefik - a modern reverse proxy. What
I liked about it has an integration with the docker API, so you don&rsquo;t need to
describe all of your routes in a configuration file, you just put all
containers in the same network and label them in the same compose file where
you describe the container.</p><h3 id=prometheus-grafana>Prometheus, Grafana</h3><p>The first thing you want to do after you have a working cluster is monitoring, so
you know how much resources are in use and what&rsquo;s the best way to distribute
them across the cluster.</p><p>As a source of data for the dashboards I use:</p><ul><li>node-exporter
This provides the necessary node information like overall usage of RAM / SPU / SSD
, disk read/write rate, network activity, etc.</li><li>arm-exporter
I use this to have information about Pi&rsquo;s temperature. It has a strict
correlation with CPU usage, but you want to make sure it&rsquo;s never higher than 50C.</li><li>cadvisor
It provides information from containers point of view. How much of the
allocated resources are in use by a service. For example, I have a limit of
256MB of RAM for Prometheus, so it goes down every day or so because OOM
killer restarts it once the RAM usage crosses the limit. Thanks to this
exporter I am aware of this and can increase the limit or do nothing (I do nothing)</li></ul><h3 id=minio>Minio</h3><p>After I configured the basic cluster, I faced a serious problem. Every time I update
the cluster, and Docker Swarm decides to move a service to another node, your
persistent data is lost, because by default Swarm supports only local volumes, it
means that volume is mounter to the current node and you have to bother
yourself syncing it between multiple nodes if you need to.</p><p>To have a shared volume, I have chosen <a href=https://minio.io/>Minio</a> cluster and <a href=https://rexray.io/>rexray</a> as an s3fs volume driver.
<a href=https://github.com/s3fs-fuse/s3fs-fuse>s3fs</a> is a file system from Amazon
that allows you to mount a bucket from s3 to the disk and store data there.
Rexray allows you to use s3fs to create volumes. However, since I wanted to go
full self-hosted, Amazon is not an option. That&rsquo;s why I use minio since it
has fully compatible API with Amazon&rsquo;s s3.
To configure all of that I had to build the Minio image because the one in
their docker registry is one year old and didn&rsquo;t work because it wasn&rsquo;t fully
UNIX compatible (mkdir didn&rsquo;t work). To make it work, you need an s3fs version
higher than 1.82, and latest fuse version that you need to compile yourself. Also
, you need a rexray plugin built for the ARM platform.
You can find all of the images in <a href=https://hub.docker.com/u/ngalayko/>my docker hub</a>.
However, I should warn you that when you manage to set this up, you find out
that write speed is extremely slow and the solution for persistence is to bind
a service to a node using placement constraints.</p><h2 id=migration>Migration</h2><p>I used to deploy all services using docker compose. You can read about it <a href=https://galaiko.rocks/posts/docker-compose-server-manegement/>here</a>.
The first step was to rewrite all compose files to version 3, so I can reuse
them for Swarm deployment.
The second step is to set up a cluster and expose it to the Internet.
To avoid downtime, I created a test domain that was a base domain for all
cluster services while I was testing it.
When cluster was ready for &ldquo;production&rdquo;, I changed DNS settings and pointer
the real domain to cluster IP, so after DNS cache was updated, all users were
migrated to the new cluster without noticing (let&rsquo;s pretend I have more than
20 daily visitors and they care about this blog).</p><p>Next plans are to set up DNS over HTTPS and VPN over HTTPS on the same cluster.</p><h2 id=links>Links</h2><ul><li><a href=https://github.com/ngalayko/server>github repo</a></li></ul></article></main><footer id=footer><style>a{color:inherit;text-decoration:none}a:hover{text-decoration:underline}</style>&copy; 2021
<a href=https://galaiko.rocks>Nikita Galaiko</a>
&#183; <a href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank rel=noopener>CC BY-NC 4.0</a></footer></body></html>
<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><meta itemprop=name content="Docker compose for managing personal server"><meta itemprop=description content="For a long time, I tried to find the most comfortable way to manage a server where I host something for myself, some kind of DevOps framework. And I think I found the best way so far.
Since most of the times things I want to host are useless and I often change my mind, there are several requirements for it:
  Easy to add/remove new components.
Let&rsquo;s say I created a website, and a couple of days later I added a DNS server on the same host, and then I went to Russia, so I also need to host VPN."><meta itemprop=datePublished content="2018-07-31T00:00:00+00:00"><meta itemprop=dateModified content="2018-07-31T00:00:00+00:00"><meta itemprop=wordCount content="578"><meta itemprop=keywords content="docker,"><meta property="og:title" content="Docker compose for managing personal server"><meta property="og:description" content="For a long time, I tried to find the most comfortable way to manage a server where I host something for myself, some kind of DevOps framework. And I think I found the best way so far.
Since most of the times things I want to host are useless and I often change my mind, there are several requirements for it:
  Easy to add/remove new components.
Let&rsquo;s say I created a website, and a couple of days later I added a DNS server on the same host, and then I went to Russia, so I also need to host VPN."><meta property="og:type" content="article"><meta property="og:url" content="https://galaiko.rocks/posts/blog/docker-compose-server-manegement/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2018-07-31T00:00:00+00:00"><meta property="article:modified_time" content="2018-07-31T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Docker compose for managing personal server"><meta name=twitter:description content="For a long time, I tried to find the most comfortable way to manage a server where I host something for myself, some kind of DevOps framework. And I think I found the best way so far.
Since most of the times things I want to host are useless and I often change my mind, there are several requirements for it:
  Easy to add/remove new components.
Let&rsquo;s say I created a website, and a couple of days later I added a DNS server on the same host, and then I went to Russia, so I also need to host VPN."><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color><link rel="shortcut icon" href=/favicon.ico><title>Docker compose for managing personal server</title><link rel=stylesheet href=https://galaiko.rocks/css/style.min.037b6ee8f8c1baab6a3d0a9da11c3ff18a7552471f16c59fd98538d5ce99208b.css integrity="sha256-A3tu6PjBuqtqPQqdoRw/8Yp1UkcfFsWf2YU41c6ZIIs=" crossorigin=anonymous></head><body id=page><header id=site-header class="animated slideInUp"><div class="hdr-wrapper section-inner"><div class=hdr-left><div class=site-branding><a href=https://galaiko.rocks>Nikita Galaiko</a></div><nav class="site-nav hide-in-mobile"><a href=https://galaiko.rocks/posts/>Posts</a>
<a href=https://galaiko.rocks/about/>About</a></nav></div><div class="hdr-right hdr-icons"><span class="hdr-social hide-in-mobile"><a href=https://github.com/ngalaiko target=_blank rel="noopener me" title=Github><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a><a href=mailto:nikita+blog@galaiko.rocks target=_blank rel="noopener me" title=Email><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1.0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1.0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg></a><a href=/keys/nikita-at-galaiko-rocks.asc target=_blank rel="noopener me" title=Pgp><svg xmlns="http://www.w3.org/2000/svg" class="feather feather-link" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71"/></svg></a></span><button id=menu-btn class=hdr-btn title=Menu><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button></div></div></header><div id=mobile-menu class="animated fast"><ul><li><a href=https://galaiko.rocks/posts/>Posts</a></li><li><a href=https://galaiko.rocks/about/>About</a></li></ul></div><main class="site-main section-inner animated fadeIn faster"><article class=thin><header class=post-header><div class=post-meta><span>Jul 31, 2018</span></div><h1>Docker compose for managing personal server</h1></header><div class=content><p>For a long time, I tried to find the most comfortable way to manage a server where I host
something for myself, some kind of DevOps framework. And I think I found the best way so far.</p><p>Since most of the times things I want to host are useless and I often change my mind,
there are several requirements for it:</p><ol><li><p><strong>Easy to add/remove new components.</strong></p><p>Let&rsquo;s say I created a website, and a couple of days later I added a DNS server
on the same host, and then I went to Russia, so I also need to host VPN. Later
I realize I don&rsquo;t really need DNS server, so I want to remove it.</p><p>Doing these things, I want to do only them. I don&rsquo;t really want to fix website
deployment while deploying VPN server, and accidentally remove VPN when stopping DNS server.</p></li><li><p><strong>No vendor lock.</strong></p><p>I want to remove, or start a new server with the same configuration on
different hosting provider any time I want. Digital Ocean, AWS, Google Cloud,
my old computer - whatever.</p></li><li><p><strong>Automate as much as possible.</strong></p><p>Deployment, https certificates for subdomains, restarting failed instances, etc.
I don&rsquo;t want to care about this at all.</p></li></ol><p>In the beginning, I was setting up Nginx on the host and Let&rsquo;s Encrypt certificates update.
So to add or remove something new I had to change nginx configuration for a hole server,
what could lead to crashing of all components because they are exposed to the world via
same Nginx. Also, I need new subdomain certs, because Let&rsquo;s encrypt didn&rsquo;t have
wildcards back then.</p><p>My first attempt to automate it was <a href=https://github.com/ngalayko/my_server>this</a>. Ansible roles
for each component (usually dockerized) and Makefile to execute them. The main problem was
that I had my own CI server running (for some reason).
That&rsquo;s why if it crashes, you should go and set it up back manually,
what is always a pain in the ass and takes some time. So a after couple of crashes,
it got boring, I stopped care about it and deleted host.</p><p>A couple of weeks ago I started this blog, so I tried to find a way to manage a host
server one more time.</p><p><a href=https://github.com/ngalayko/server>Here</a> it is.</p><p>There are 2 components:</p><ol><li><p><a href=https://github.com/ngalayko/server/blob/master/docker-compose.yml>Automated nginx-docker-with-lets-encrypt compose file</a></p><p>What it does is generating nginx configuration based on other containers in the
same docker network and taking care of https for them. You can read more in the
repository readme file, but basically, it contains three parts: nginx, nginx configuration generator
and a certificates generator using Let&rsquo;s Encrypt.</p><p>That allows us to add new components easily - just add new service to compose file
or remove one. Also, does not depend on host provider, because can be run on
pretty much any operating system.</p></li><li><p><a href=https://github.com/ngalayko/server/tree/master/.travis>Travis deployment</a></p><p>It logs in via ssh to your remote server and runs deployment script there.
Step-to-step explanation on how to set it up you can find
<a href=https://gist.github.com/nickbclifford/16c5be884c8a15dca02dca09f65f97bd>here</a>.
Only change I made there - added environment variables export, so it&rsquo;s possible
to strore secret keys in Travis.</p></li></ol><p>That&rsquo;s it! Travis <a href=https://github.com/ngalayko/server/blob/master/scripts/update.sh>executes</a> all compose files
in the folder, and removes orphan containers.</p><p>To add a new component to the system, I need to create a <a href=https://github.com/ngalayko/server/tree/master/blog>new folder</a>
or <a href=https://github.com/umputun/remark/tree/e278da3cd074b86c5d59359e4f1c615ab6f98b93>add git submodule</a> with a Dockerized
app and add a <a href=https://github.com/ngalayko/server/blob/master/docker-compose.dns.yml>docker-compose file</a>
to run it, following some rules, so nginx container can find it and create routes.</p><h2 id=links>Links<a href=#links class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><ul><li><a href=https://gist.github.com/nickbclifford/16c5be884c8a15dca02dca09f65f97bd>Travis deployment configuration</a></li><li><a href=https://github.com/JrCs/docker-letsencrypt-nginx-proxy-companion>Docker Let&rsquo;s Encrypt Nginx proxy companion</a></li></ul></div><hr class=post-end><footer class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=tag><a href=https://galaiko.rocks/tags/docker>docker</a></span></p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>578 Words</p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>2018-07-31 00:00 +0000</p></footer></article><div class="post-nav thin"><a class=next-post href=https://galaiko.rocks/posts/blog/privacy/><span class=post-nav-label><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>&nbsp;Newer</span><br><span>Internet privacy starter pack</span></a>
<a class=prev-post href=https://galaiko.rocks/posts/blog/half-a-year-with-vim/><span class=post-nav-label>Older&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg></span><br><span>Half a year with vim</span></a></div><div id=comments class=thin></div></main><footer id=site-footer class="section-inner thin animated fadeIn faster"><p>&copy; 2021 <a href=https://galaiko.rocks>Nikita Galaiko</a> &#183; <a href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank rel=noopener>CC BY-NC 4.0</a></p><p>Made with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> &#183; Theme <a href=https://github.com/Track3/hermit target=_blank rel=noopener>Hermit</a> &#183; <a href=https://galaiko.rocks/posts/index.xml target=_blank title=rss><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></p></footer><script src=https://galaiko.rocks/js/bundle.min.7d8545daa55d62427355498dd8da13f98ff79a7938ce7d2a5e2ae1ec0de3beb8.js integrity="sha256-fYVF2qVdYkJzVUmN2NoT+Y/3mnk4zn0qXirh7A3jvrg=" crossorigin=anonymous></script></body></html>
<!doctype html><html><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Nikita Galaiko"><link rel="shortcut icon" href=https://galaiko.rocks/favicon.ico><style>*,*:before,*:after{box-sizing:border-box}html{font-size:62.5%}body{font-size:16px;font-size:1.6rem;font-family:helvetica neue,arial,sans-serif;color:#313a3d;width:100%;margin:0 auto;padding:0 16px;line-height:1.6}header#banner{margin:25px 0}header#banner a{color:#313a3d;text-decoration:none}header#banner a:hover{text-decoration:underline}header#banner h2{display:inline;font-size:21px;font-size:2.1rem;margin:0 8px 0 0}header#banner nav{display:inline-block}header#banner nav ul{list-style-type:none;font-size:1.05em;text-transform:lowercase;margin:0;padding:0}header#banner nav ul li{display:inline;margin:0 3px}header#banner nav ul li a{color:#454545}main#content a{color:#007dfa;text-decoration:none}main#content a:hover{text-decoration:underline}main#content h1,main#content h2,main#content h3,main#content h4,main#content h5,main#content h6{margin-bottom:0;line-height:1.15}main#content h3{font-size:19px;font-size:1.9rem}main#content h1+p,main#content h2+p,main#content h3+p,main#content h4+p,main#content h5+p,main#content h6+p{margin-top:5px}main#content p{color:#394548;margin:16px 0}main#content hr{height:1px;border:0;background:#d8d8d8}main#content ul#posts{list-style-type:none;font-size:16px;font-size:1.6rem;margin-top:0;padding:0}main#content ul#posts li{margin:5px 0;padding:0}main#content ul#posts small{font-size:.8em;color:#767676;margin-left:10px}main#content ul#posts li a{text-decoration:none}main#content ul#posts li a:hover{color:#369aff}main#content ul#posts li a:hover small{color:inherit}main#content header#post-header h1{display:block;font-size:23px;font-size:2.3rem;line-height:1.15}main#content header#post-header div{display:block;font-size:.85em;color:#767676}main#content #toc{border:1px solid #b1b1b1;border-radius:1px;line-height:26px;margin:16px 0;padding:9px 14px}main#content #toc h4{font-size:1.06em;color:#3d3d3d;margin:0}main#content #toc nav#TableOfContents{margin-top:4px}main#content #toc nav#TableOfContents>ul,main#content #toc nav#TableOfContents>ol{margin-left:-40px}main#content #toc ul,main#content #toc ol{font-size:.98em;margin:0;padding:0 0 0 40px}main#content #toc ul{list-style-type:none}main#content #toc ol{counter-reset:item}main#content #toc ol li{display:block}main#content #toc ol li:before{content:counters(item,".")". ";counter-increment:item}main#content img{max-width:100%;margin:0 auto}main#content figure{margin:16px 0}main#content figure img{display:block;max-width:100%;margin:0 auto}main#content figure figcaption{font-size:.92em;font-style:italic;line-height:22px;text-align:center;margin-top:6px;padding:0 10px}main#content figure figcaption h4{font-style:normal;display:inline;margin:0}main#content figure figcaption p{display:inline;margin:0;padding-left:8px}main#content blockquote{font-style:italic;margin-top:10px;margin-bottom:10px;margin-left:50px;padding-left:15px;border-left:3px solid #ccc}main#content code,main#content pre{font-family:menlo,monospace}main#content code{font-size:.96em;padding:0 5px}main#content pre{display:block;overflow-x:auto;font-size:14px;font-size:1.4rem;white-space:pre;margin:20px 0;padding:1.5rem;line-height:1.4}main#content pre code{padding:0}main#content section.footnotes{font-size:.9em}footer#footer{font-size:14px;font-size:1.4rem;font-weight:300;color:#949494;margin:40px 0}html{scrollbar-color:#6c6c6c #2e2e2e}body{color:#282828;background:#fbf1c7}header#banner a{color:#282828;text-decoration:none}header#banner nav ul li a{color:#504945}main#content a{color:#076678}main#content p{color:#3c3836}main#content hr{background:#d8d8d8}main#content #toc h4{color:#3d3d3d}main#content ul#posts small{color:#7c6f64}main#content ul#posts li a:hover{color:#458588}main#content header#post-header div{color:#7c6f64}@media(min-width:770px){body{width:600px;line-height:1.5}main#content hr{width:108%;margin-left:-3.8%}header#banner h2{font-size:25px;font-size:2.5rem}main#content h3{font-size:20px;font-size:2rem}main#content ul#posts{font-size:18px;font-size:1.8rem}main#content header#post-header h1{font-size:26px;font-size:2.6rem}main#content img{max-width:108%;margin-left:-3.8%}main#content figure{margin-left:-3.8%}main#content figure img{max-width:108%}main#content pre{width:108%;margin-left:-3.8%;padding:1.5rem 2.2rem}}@media(prefers-color-scheme:dark){html{scrollbar-color:#6c6c6c #2e2e2e}body{color:#fbf1c7;background:#282828}header#banner a{color:#fbf1c7;text-decoration:none}header#banner nav ul li a{color:#d5c4a1}main#content a{color:#83a598}main#content p{color:#ebdbb2}main#content hr{background:#5c5c5c}main#content #toc h4{color:#d4d4d4}main#content ul#posts small{color:#a89984}main#content ul#posts li a:hover{color:#458588}main#content header#post-header div{color:#a89984}}</style><title>Golang: Data races</title></head><body><header id=banner><h2><a href=https://galaiko.rocks>Nikita Galaiko</a></h2><nav><ul><li><a href=/posts/ title>Posts</a></li><li><a href=/about/ title>About</a></li><li><a href=/posts/index.xml title>RSS</a></li></ul></nav></header><main id=content><article><header id=post-header><h1>Golang: Data races</h1><div><time>February 2, 2019</time></div></header><p>I have noticed that many people who have started using go have troubles when it
comes to concurrent programming. Concurrency in go is indeed the most
complicated part of the language, especially for people who don&rsquo;t have much
experience working with it. There are no compile time validations to prevent a
programmer from creating race conditions, but go provides all the needed
tools and instruments to avoid it.</p><p>I will try to explain what is a race condition, why does it happen and how to
avoid it.</p><p>Wikipedia:</p><blockquote><p>A race condition or race hazard is the behavior of an electronics, software,
or another system where the system&rsquo;s substantive behavior is dependent on the
sequence or timing of other uncontrollable events. It becomes a bug when one or
more of the possible behaviors is undesirable.</p></blockquote><p>Let&rsquo;s say we have a list of links to Wikipedia pages that we want to download.</p><p>I wrote a <a href=https://github.com/ngalayko/examples/tree/master/concurrency/examples/download>simple tool</a> as an example that uses the interface to do that:</p><div class=highlight><pre class=chroma><code class=language-go data-lang=go><span class=kd>type</span> <span class=nx>Downloader</span> <span class=kd>interface</span> <span class=p>{</span>
	<span class=nf>Download</span><span class=p>(</span><span class=o>...*</span><span class=nx>url</span><span class=p>.</span><span class=nx>URL</span><span class=p>)</span> <span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=o>*</span><span class=nx>url</span><span class=p>.</span><span class=nx>URL</span><span class=p>][]</span><span class=kt>byte</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span>
<span class=p>}</span>
</code></pre></div><p>The most straightforward implementation would be to iterate over a list of urls,
download each of them and store in the resulting map:</p><div class=highlight><pre class=chroma><code class=language-go data-lang=go><span class=kd>type</span> <span class=nx>Downloader</span> <span class=kd>struct</span> <span class=p>{</span>
	<span class=nx>client</span> <span class=o>*</span><span class=nx>http</span><span class=p>.</span><span class=nx>Client</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=p>(</span><span class=nx>d</span> <span class=o>*</span><span class=nx>Downloader</span><span class=p>)</span> <span class=nf>Download</span><span class=p>(</span><span class=nx>urls</span> <span class=o>...*</span><span class=nx>url</span><span class=p>.</span><span class=nx>URL</span><span class=p>)</span> <span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=o>*</span><span class=nx>url</span><span class=p>.</span><span class=nx>URL</span><span class=p>][]</span><span class=kt>byte</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
	<span class=nx>result</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=o>*</span><span class=nx>url</span><span class=p>.</span><span class=nx>URL</span><span class=p>][]</span><span class=kt>byte</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=nx>urls</span><span class=p>))</span>
	<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>u</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>urls</span> <span class=p>{</span>
		<span class=nx>data</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>d</span><span class=p>.</span><span class=nf>download</span><span class=p>(</span><span class=nx>u</span><span class=p>)</span>
		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
			<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;error downloading %s: %s&#34;</span><span class=p>,</span> <span class=nx>u</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
		<span class=p>}</span>
		<span class=nx>result</span><span class=p>[</span><span class=nx>u</span><span class=p>]</span> <span class=p>=</span> <span class=nx>data</span>
	<span class=p>}</span>
	<span class=k>return</span> <span class=nx>result</span><span class=p>,</span> <span class=kc>nil</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=p>(</span><span class=nx>d</span> <span class=o>*</span><span class=nx>Downloader</span><span class=p>)</span> <span class=nf>download</span><span class=p>(</span><span class=nx>u</span> <span class=o>*</span><span class=nx>url</span><span class=p>.</span><span class=nx>URL</span><span class=p>)</span> <span class=p>([]</span><span class=kt>byte</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
	<span class=nx>resp</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>d</span><span class=p>.</span><span class=nx>client</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=nx>u</span><span class=p>.</span><span class=nf>String</span><span class=p>())</span>
	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
	<span class=p>}</span>
	<span class=k>defer</span> <span class=nx>resp</span><span class=p>.</span><span class=nx>Body</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
	<span class=k>return</span> <span class=nx>ioutil</span><span class=p>.</span><span class=nf>ReadAll</span><span class=p>(</span><span class=nx>resp</span><span class=p>.</span><span class=nx>Body</span><span class=p>)</span>
<span class=p>}</span>
</code></pre></div><p>The code works, but not so fast, because the total time to download links is a sum
of times to download for each link. It&rsquo;s really inefficient when the number of
links is big. For me, it took over 16s to download 100 links. To improve it, let&rsquo;s
change the code, so we download all links at the same time:</p><div class=highlight><pre class=chroma><code class=language-go data-lang=go><span class=kd>func</span> <span class=p>(</span><span class=nx>d</span> <span class=o>*</span><span class=nx>Downloader</span><span class=p>)</span> <span class=nf>Download</span><span class=p>(</span><span class=nx>urls</span> <span class=o>...*</span><span class=nx>url</span><span class=p>.</span><span class=nx>URL</span><span class=p>)</span> <span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=o>*</span><span class=nx>url</span><span class=p>.</span><span class=nx>URL</span><span class=p>][]</span><span class=kt>byte</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
	<span class=nx>result</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=o>*</span><span class=nx>url</span><span class=p>.</span><span class=nx>URL</span><span class=p>][]</span><span class=kt>byte</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=nx>urls</span><span class=p>))</span>

	<span class=nx>wg</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>sync</span><span class=p>.</span><span class=nx>WaitGroup</span><span class=p>{}</span>
	<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>u</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>urls</span> <span class=p>{</span>
		<span class=nx>wg</span><span class=p>.</span><span class=nf>Add</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
		<span class=k>go</span> <span class=kd>func</span><span class=p>(</span><span class=nx>u</span> <span class=o>*</span><span class=nx>url</span><span class=p>.</span><span class=nx>URL</span><span class=p>)</span> <span class=p>{</span>
			<span class=nx>data</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>d</span><span class=p>.</span><span class=nf>download</span><span class=p>(</span><span class=nx>u</span><span class=p>)</span>
			<span class=nx>result</span><span class=p>[</span><span class=nx>u</span><span class=p>]</span> <span class=p>=</span> <span class=nx>data</span>
			<span class=nx>wg</span><span class=p>.</span><span class=nf>Done</span><span class=p>()</span>
		<span class=p>}(</span><span class=nx>u</span><span class=p>)</span>
	<span class=p>}</span>
	<span class=nx>wg</span><span class=p>.</span><span class=nf>Wait</span><span class=p>()</span>

	<span class=k>return</span> <span class=nx>result</span><span class=p>,</span> <span class=kc>nil</span>
<span class=p>}</span>
</code></pre></div><p>To do that, we have wrapped our <code>download</code> function to run in its goroutine.
Wait group here is used to wait until all of the urls are downloaded, so the
total time equals the time to download the heavies page. On my test run, it
is <code>679.53154ms</code> for 100 pages. Down from sixteen seconds to less than a second -
an impressive result!</p><p>But here is a problem:</p><pre><code>==================
WARNING: DATA RACE
Write at 0x00c0007baf60 by goroutine 257:
  runtime.mapassign_fast64()
      /usr/local/go/src/runtime/map_fast64.go:92 +0x0
  github.com/ngalayko/talks/concurrency/examples/download/downloader/race.(*Downloader).Download.func1()
      /Users/nikitagalaiko/golang/src/github.com/ngalayko/talks/concurrency/examples/download/downloader/race/downloader.go:37 +0x8e

Previous write at 0x00c0007baf60 by goroutine 262:
  runtime.mapassign_fast64()
      /usr/local/go/src/runtime/map_fast64.go:92 +0x0
  github.com/ngalayko/talks/concurrency/examples/download/downloader/race.(*Downloader).Download.func1()
      /Users/nikitagalaiko/golang/src/github.com/ngalayko/talks/concurrency/examples/download/downloader/race/downloader.go:37 +0x8e

Goroutine 257 (running) created at:
  github.com/ngalayko/talks/concurrency/examples/download/downloader/race.(*Downloader).Download()
      /Users/nikitagalaiko/golang/src/github.com/ngalayko/talks/concurrency/examples/download/downloader/race/downloader.go:35 +0x123
  main.run()
      /Users/nikitagalaiko/golang/src/github.com/ngalayko/talks/concurrency/examples/download/cmd/download/main.go:71 +0x8e
  main.main()
      /Users/nikitagalaiko/golang/src/github.com/ngalayko/talks/concurrency/examples/download/cmd/download/main.go:56 +0x3b4

Goroutine 262 (finished) created at:
  github.com/ngalayko/talks/concurrency/examples/download/downloader/race.(*Downloader).Download()
      /Users/nikitagalaiko/golang/src/github.com/ngalayko/talks/concurrency/examples/download/downloader/race/downloader.go:35 +0x123
  main.run()
      /Users/nikitagalaiko/golang/src/github.com/ngalayko/talks/concurrency/examples/download/cmd/download/main.go:71 +0x8e
  main.main()
      /Users/nikitagalaiko/golang/src/github.com/ngalayko/talks/concurrency/examples/download/cmd/download/main.go:56 +0x3b4
==================
</code></pre><p>I&rsquo;ve built the code with <code>-race</code> flag to enable golang race detector and got a
warning about the data race. Of cource, a warning is not an error, and we can
ignore it, the result was correct: we&rsquo;ve downloaded a page for each link.</p><p>But why race detector does not agree?</p><p>First, let&rsquo;s see what lines he doesn&rsquo;t like:</p><div class=highlight><pre class=chroma><code class=language-go data-lang=go>    <span class=nx>result</span><span class=p>[</span><span class=nx>u</span><span class=p>]</span> <span class=p>=</span> <span class=nx>data</span>
</code></pre></div><p>A map is a data structure that contains keys and values. All keys are unique,
and each key has an associated value with it. For the sake of the example
let&rsquo;s say that every key is associated with a particular address in the memory,
and the address is permanent.</p><p>So when we are updating the key&rsquo;s value, we are updating data at the same address
in the memory.</p><p>In our example, we have unique urls, we download each of them and place the content
to the individual memory address associated with a map key.</p><p>But what should happen when we write different data into the same key? If we
follow the abstractions of a map that I&rsquo;ve described above and goroutines -
light-weight threads that are running concurrently at the same time - then the
final value for the map is not determined.</p><p>Because what happens is that we are telling go to write some data at the same
memory address multiple times at the same time. This can cause all kinds of
problems - from the unexpected result for a programmer to data corruption. And it&rsquo;s
not a responsibility of a language to decide what does a programmer wants to see
as a result. And a result in the situation depends on uncontrollable events.</p><p>That&rsquo;s why go gives us a warning. It can&rsquo;t guarantee the result.</p><p>It doesn&rsquo;t apply only to maps. The same can happen when you share a pointer
between two goroutines. Or you are writing to the same file from two different
programmes, or maybe you are saving data from two instances of your applications to
the same database. These all are different kinds of the same problem.</p><blockquote><p>Data races happen only when you have multiple threads/goroutines/processes that
can access the same data at the same time.</p></blockquote><p>Likely, that problem was around for a while, and there is a solution to it.</p><blockquote><p>You need to make sure that only one process has access to the same piece of
memory at a time.</p></blockquote><p>Though, there is a difference between write and read access. Reading the same
data from multiple threads is safe. The problems start only when you have
a thread that writes.</p><p>Golang has a few instruments to deal with data races like mutexes and channels.</p><p>Mutexes are used to solve exactly data race problems, here how to use them:</p><div class=highlight><pre class=chroma><code class=language-go data-lang=go><span class=kd>func</span> <span class=p>(</span><span class=nx>d</span> <span class=o>*</span><span class=nx>Downloader</span><span class=p>)</span> <span class=nf>Download</span><span class=p>(</span><span class=nx>urls</span> <span class=o>...*</span><span class=nx>url</span><span class=p>.</span><span class=nx>URL</span><span class=p>)</span> <span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=o>*</span><span class=nx>url</span><span class=p>.</span><span class=nx>URL</span><span class=p>][]</span><span class=kt>byte</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
	<span class=nx>result</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=o>*</span><span class=nx>url</span><span class=p>.</span><span class=nx>URL</span><span class=p>][]</span><span class=kt>byte</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=nx>urls</span><span class=p>))</span>
	<span class=nx>wg</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>sync</span><span class=p>.</span><span class=nx>WaitGroup</span><span class=p>{}</span>

	<span class=nx>guard</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>sync</span><span class=p>.</span><span class=nx>Mutex</span><span class=p>{}</span>

	<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>u</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>urls</span> <span class=p>{</span>
		<span class=nx>wg</span><span class=p>.</span><span class=nf>Add</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
		<span class=k>go</span> <span class=kd>func</span><span class=p>(</span><span class=nx>u</span> <span class=o>*</span><span class=nx>url</span><span class=p>.</span><span class=nx>URL</span><span class=p>)</span> <span class=p>{</span>
			<span class=nx>data</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>d</span><span class=p>.</span><span class=nf>download</span><span class=p>(</span><span class=nx>u</span><span class=p>)</span>

			<span class=nx>guard</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
			<span class=nx>result</span><span class=p>[</span><span class=nx>u</span><span class=p>]</span> <span class=p>=</span> <span class=nx>data</span>
			<span class=nx>guard</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>

			<span class=nx>wg</span><span class=p>.</span><span class=nf>Done</span><span class=p>()</span>
		<span class=p>}(</span><span class=nx>u</span><span class=p>)</span>
	<span class=p>}</span>
	<span class=nx>wg</span><span class=p>.</span><span class=nf>Wait</span><span class=p>()</span>
	<span class=k>return</span> <span class=nx>result</span><span class=p>,</span> <span class=kc>nil</span>
<span class=p>}</span>
</code></pre></div><p>It has two methods, <code>Lock</code> and <code>Unlock</code>. Everything between them can be accessed
only by one goroutine at a time. Others will wait for the mutex to unlock before
they can access it.</p><p>Channels are a bit more tricky, and can be also used to controll goroutines:</p><div class=highlight><pre class=chroma><code class=language-go data-lang=go><span class=kd>type</span> <span class=nx>done</span> <span class=kd>struct</span> <span class=p>{</span>
	<span class=nx>u</span>    <span class=o>*</span><span class=nx>url</span><span class=p>.</span><span class=nx>URL</span>
	<span class=nx>data</span> <span class=p>[]</span><span class=kt>byte</span>
	<span class=nx>err</span>  <span class=kt>error</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=p>(</span><span class=nx>d</span> <span class=o>*</span><span class=nx>Downloader</span><span class=p>)</span> <span class=nf>Download</span><span class=p>(</span><span class=nx>urls</span> <span class=o>...*</span><span class=nx>url</span><span class=p>.</span><span class=nx>URL</span><span class=p>)</span> <span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=o>*</span><span class=nx>url</span><span class=p>.</span><span class=nx>URL</span><span class=p>][]</span><span class=kt>byte</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
	<span class=nx>result</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=o>*</span><span class=nx>url</span><span class=p>.</span><span class=nx>URL</span><span class=p>][]</span><span class=kt>byte</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=nx>urls</span><span class=p>))</span>

	<span class=nx>doneChan</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=o>*</span><span class=nx>done</span><span class=p>)</span>

	<span class=nx>wg</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>sync</span><span class=p>.</span><span class=nx>WaitGroup</span><span class=p>{}</span>
	<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>u</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>urls</span> <span class=p>{</span>
		<span class=nx>wg</span><span class=p>.</span><span class=nf>Add</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
		<span class=k>go</span> <span class=kd>func</span><span class=p>(</span><span class=nx>u</span> <span class=o>*</span><span class=nx>url</span><span class=p>.</span><span class=nx>URL</span><span class=p>)</span> <span class=p>{</span>
			<span class=nx>data</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>d</span><span class=p>.</span><span class=nf>download</span><span class=p>(</span><span class=nx>u</span><span class=p>)</span>
			<span class=nx>doneChan</span> <span class=o>&lt;-</span> <span class=o>&amp;</span><span class=nx>done</span><span class=p>{</span>
				<span class=nx>u</span><span class=p>:</span>    <span class=nx>u</span><span class=p>,</span>
				<span class=nx>data</span><span class=p>:</span> <span class=nx>data</span><span class=p>,</span>
				<span class=nx>err</span><span class=p>:</span>  <span class=nx>err</span><span class=p>,</span>
			<span class=p>}</span>
			<span class=nx>wg</span><span class=p>.</span><span class=nf>Done</span><span class=p>()</span>
		<span class=p>}(</span><span class=nx>u</span><span class=p>)</span>
	<span class=p>}</span>

	<span class=k>go</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
		<span class=nx>wg</span><span class=p>.</span><span class=nf>Wait</span><span class=p>()</span>
		<span class=nb>close</span><span class=p>(</span><span class=nx>doneChan</span><span class=p>)</span>
	<span class=p>}()</span>

	<span class=k>for</span> <span class=nx>done</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>doneChan</span> <span class=p>{</span>
		<span class=k>if</span> <span class=nx>done</span><span class=p>.</span><span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
			<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;error downloading %s: %s&#34;</span><span class=p>,</span> <span class=nx>done</span><span class=p>.</span><span class=nx>u</span><span class=p>,</span> <span class=nx>done</span><span class=p>.</span><span class=nx>err</span><span class=p>)</span>
		<span class=p>}</span>
		<span class=nx>result</span><span class=p>[</span><span class=nx>done</span><span class=p>.</span><span class=nx>u</span><span class=p>]</span> <span class=p>=</span> <span class=nx>done</span><span class=p>.</span><span class=nx>data</span>
	<span class=p>}</span>

	<span class=k>return</span> <span class=nx>result</span><span class=p>,</span> <span class=kc>nil</span>
<span class=p>}</span>
</code></pre></div><p>Data from the multiple goroutines sent to the single goroutine via a channel and
that goroutine stores the data in the map.</p><h2 id=links>Links:</h2><ul><li><a href=https://github.com/ngalayko/examples/tree/master/concurrency/examples/download>example</a></li></ul></article></main><footer id=footer><style>a{color:inherit;text-decoration:none}a:hover{text-decoration:underline}</style>&copy; 2021
<a href=https://galaiko.rocks>Nikita Galaiko</a>
&#183; <a href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank rel=noopener>CC BY-NC 4.0</a></footer></body></html>
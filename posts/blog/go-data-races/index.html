<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=theme-color content="#494f5c"><meta name=msapplication-TileColor content="#494f5c"><meta itemprop=name content="Golang: Data races"><meta itemprop=description content="I have noticed that many people who have started using go have troubles when it comes to concurrent programming. Concurrency in go is indeed the most complicated part of the language, especially for people who don&rsquo;t have much experience working with it. There are no compile time validations to prevent a programmer from creating race conditions, but go provides all the needed tools and instruments to avoid it.
I will try to explain what is a race condition, why does it happen and how to avoid it."><meta itemprop=datePublished content="2019-02-02T00:00:00+00:00"><meta itemprop=dateModified content="2019-02-02T00:00:00+00:00"><meta itemprop=wordCount content="1169"><meta itemprop=keywords content="go,data race,race condition,"><meta property="og:title" content="Golang: Data races"><meta property="og:description" content="I have noticed that many people who have started using go have troubles when it comes to concurrent programming. Concurrency in go is indeed the most complicated part of the language, especially for people who don&rsquo;t have much experience working with it. There are no compile time validations to prevent a programmer from creating race conditions, but go provides all the needed tools and instruments to avoid it.
I will try to explain what is a race condition, why does it happen and how to avoid it."><meta property="og:type" content="article"><meta property="og:url" content="https://galaiko.rocks/posts/blog/go-data-races/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-02-02T00:00:00+00:00"><meta property="article:modified_time" content="2019-02-02T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Golang: Data races"><meta name=twitter:description content="I have noticed that many people who have started using go have troubles when it comes to concurrent programming. Concurrency in go is indeed the most complicated part of the language, especially for people who don&rsquo;t have much experience working with it. There are no compile time validations to prevent a programmer from creating race conditions, but go provides all the needed tools and instruments to avoid it.
I will try to explain what is a race condition, why does it happen and how to avoid it."><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color><link rel="shortcut icon" href=/favicon.ico><title>Golang: Data races</title><link rel=stylesheet href=https://galaiko.rocks/css/style.min.037b6ee8f8c1baab6a3d0a9da11c3ff18a7552471f16c59fd98538d5ce99208b.css integrity="sha256-A3tu6PjBuqtqPQqdoRw/8Yp1UkcfFsWf2YU41c6ZIIs=" crossorigin=anonymous></head><body id=page><header id=site-header class="animated slideInUp"><div class="hdr-wrapper section-inner"><div class=hdr-left><div class=site-branding><a href=https://galaiko.rocks>Nikita Galaiko</a></div><nav class="site-nav hide-in-mobile"><a href=https://galaiko.rocks/posts/>Posts</a>
<a href=https://galaiko.rocks/about/>About</a></nav></div><div class="hdr-right hdr-icons"><span class="hdr-social hide-in-mobile"><a href=https://github.com/ngalaiko target=_blank rel="noopener me" title=Github><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a><a href=mailto:nikita+blog@galaiko.rocks target=_blank rel="noopener me" title=Email><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1.0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1.0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg></a><a href=/keys/nikita-at-galaiko-rocks.asc target=_blank rel="noopener me" title=Pgp><svg xmlns="http://www.w3.org/2000/svg" class="feather feather-link" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71"/></svg></a></span><button id=menu-btn class=hdr-btn title=Menu><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button></div></div></header><div id=mobile-menu class="animated fast"><ul><li><a href=https://galaiko.rocks/posts/>Posts</a></li><li><a href=https://galaiko.rocks/about/>About</a></li></ul></div><main class="site-main section-inner animated fadeIn faster"><article class=thin><header class=post-header><div class=post-meta><span>Feb 2, 2019</span></div><h1>Golang: Data races</h1></header><div class=content><p>I have noticed that many people who have started using go have troubles when it
comes to concurrent programming. Concurrency in go is indeed the most
complicated part of the language, especially for people who don&rsquo;t have much
experience working with it. There are no compile time validations to prevent a
programmer from creating race conditions, but go provides all the needed
tools and instruments to avoid it.</p><p>I will try to explain what is a race condition, why does it happen and how to
avoid it.</p><p>Wikipedia:</p><blockquote><p>A race condition or race hazard is the behavior of an electronics, software,
or another system where the system&rsquo;s substantive behavior is dependent on the
sequence or timing of other uncontrollable events. It becomes a bug when one or
more of the possible behaviors is undesirable.</p></blockquote><p>Let&rsquo;s say we have a list of links to Wikipedia pages that we want to download.</p><p>I wrote a <a href=https://github.com/ngalayko/examples/tree/master/concurrency/examples/download>simple tool</a> as an example that uses the interface to do that:</p><div class=highlight><pre class=chroma><code class=language-go data-lang=go><span class=kd>type</span> <span class=nx>Downloader</span> <span class=kd>interface</span> <span class=p>{</span>
	<span class=nf>Download</span><span class=p>(</span><span class=o>...*</span><span class=nx>url</span><span class=p>.</span><span class=nx>URL</span><span class=p>)</span> <span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=o>*</span><span class=nx>url</span><span class=p>.</span><span class=nx>URL</span><span class=p>][]</span><span class=kt>byte</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span>
<span class=p>}</span>
</code></pre></div><p>The most straightforward implementation would be to iterate over a list of urls,
download each of them and store in the resulting map:</p><div class=highlight><pre class=chroma><code class=language-go data-lang=go><span class=kd>type</span> <span class=nx>Downloader</span> <span class=kd>struct</span> <span class=p>{</span>
	<span class=nx>client</span> <span class=o>*</span><span class=nx>http</span><span class=p>.</span><span class=nx>Client</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=p>(</span><span class=nx>d</span> <span class=o>*</span><span class=nx>Downloader</span><span class=p>)</span> <span class=nf>Download</span><span class=p>(</span><span class=nx>urls</span> <span class=o>...*</span><span class=nx>url</span><span class=p>.</span><span class=nx>URL</span><span class=p>)</span> <span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=o>*</span><span class=nx>url</span><span class=p>.</span><span class=nx>URL</span><span class=p>][]</span><span class=kt>byte</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
	<span class=nx>result</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=o>*</span><span class=nx>url</span><span class=p>.</span><span class=nx>URL</span><span class=p>][]</span><span class=kt>byte</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=nx>urls</span><span class=p>))</span>
	<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>u</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>urls</span> <span class=p>{</span>
		<span class=nx>data</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>d</span><span class=p>.</span><span class=nf>download</span><span class=p>(</span><span class=nx>u</span><span class=p>)</span>
		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
			<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;error downloading %s: %s&#34;</span><span class=p>,</span> <span class=nx>u</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
		<span class=p>}</span>
		<span class=nx>result</span><span class=p>[</span><span class=nx>u</span><span class=p>]</span> <span class=p>=</span> <span class=nx>data</span>
	<span class=p>}</span>
	<span class=k>return</span> <span class=nx>result</span><span class=p>,</span> <span class=kc>nil</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=p>(</span><span class=nx>d</span> <span class=o>*</span><span class=nx>Downloader</span><span class=p>)</span> <span class=nf>download</span><span class=p>(</span><span class=nx>u</span> <span class=o>*</span><span class=nx>url</span><span class=p>.</span><span class=nx>URL</span><span class=p>)</span> <span class=p>([]</span><span class=kt>byte</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
	<span class=nx>resp</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>d</span><span class=p>.</span><span class=nx>client</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=nx>u</span><span class=p>.</span><span class=nf>String</span><span class=p>())</span>
	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
	<span class=p>}</span>
	<span class=k>defer</span> <span class=nx>resp</span><span class=p>.</span><span class=nx>Body</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
	<span class=k>return</span> <span class=nx>ioutil</span><span class=p>.</span><span class=nf>ReadAll</span><span class=p>(</span><span class=nx>resp</span><span class=p>.</span><span class=nx>Body</span><span class=p>)</span>
<span class=p>}</span>
</code></pre></div><p>The code works, but not so fast, because the total time to download links is a sum
of times to download for each link. It&rsquo;s really inefficient when the number of
links is big. For me, it took over 16s to download 100 links. To improve it, let&rsquo;s
change the code, so we download all links at the same time:</p><div class=highlight><pre class=chroma><code class=language-go data-lang=go><span class=kd>func</span> <span class=p>(</span><span class=nx>d</span> <span class=o>*</span><span class=nx>Downloader</span><span class=p>)</span> <span class=nf>Download</span><span class=p>(</span><span class=nx>urls</span> <span class=o>...*</span><span class=nx>url</span><span class=p>.</span><span class=nx>URL</span><span class=p>)</span> <span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=o>*</span><span class=nx>url</span><span class=p>.</span><span class=nx>URL</span><span class=p>][]</span><span class=kt>byte</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
	<span class=nx>result</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=o>*</span><span class=nx>url</span><span class=p>.</span><span class=nx>URL</span><span class=p>][]</span><span class=kt>byte</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=nx>urls</span><span class=p>))</span>

	<span class=nx>wg</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>sync</span><span class=p>.</span><span class=nx>WaitGroup</span><span class=p>{}</span>
	<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>u</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>urls</span> <span class=p>{</span>
		<span class=nx>wg</span><span class=p>.</span><span class=nf>Add</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
		<span class=k>go</span> <span class=kd>func</span><span class=p>(</span><span class=nx>u</span> <span class=o>*</span><span class=nx>url</span><span class=p>.</span><span class=nx>URL</span><span class=p>)</span> <span class=p>{</span>
			<span class=nx>data</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>d</span><span class=p>.</span><span class=nf>download</span><span class=p>(</span><span class=nx>u</span><span class=p>)</span>
			<span class=nx>result</span><span class=p>[</span><span class=nx>u</span><span class=p>]</span> <span class=p>=</span> <span class=nx>data</span>
			<span class=nx>wg</span><span class=p>.</span><span class=nf>Done</span><span class=p>()</span>
		<span class=p>}(</span><span class=nx>u</span><span class=p>)</span>
	<span class=p>}</span>
	<span class=nx>wg</span><span class=p>.</span><span class=nf>Wait</span><span class=p>()</span>

	<span class=k>return</span> <span class=nx>result</span><span class=p>,</span> <span class=kc>nil</span>
<span class=p>}</span>
</code></pre></div><p>To do that, we have wrapped our <code>download</code> function to run in its goroutine.
Wait group here is used to wait until all of the urls are downloaded, so the
total time equals the time to download the heavies page. On my test run, it
is <code>679.53154ms</code> for 100 pages. Down from sixteen seconds to less than a second -
an impressive result!</p><p>But here is a problem:</p><pre><code>==================
WARNING: DATA RACE
Write at 0x00c0007baf60 by goroutine 257:
  runtime.mapassign_fast64()
      /usr/local/go/src/runtime/map_fast64.go:92 +0x0
  github.com/ngalayko/talks/concurrency/examples/download/downloader/race.(*Downloader).Download.func1()
      /Users/nikitagalaiko/golang/src/github.com/ngalayko/talks/concurrency/examples/download/downloader/race/downloader.go:37 +0x8e

Previous write at 0x00c0007baf60 by goroutine 262:
  runtime.mapassign_fast64()
      /usr/local/go/src/runtime/map_fast64.go:92 +0x0
  github.com/ngalayko/talks/concurrency/examples/download/downloader/race.(*Downloader).Download.func1()
      /Users/nikitagalaiko/golang/src/github.com/ngalayko/talks/concurrency/examples/download/downloader/race/downloader.go:37 +0x8e

Goroutine 257 (running) created at:
  github.com/ngalayko/talks/concurrency/examples/download/downloader/race.(*Downloader).Download()
      /Users/nikitagalaiko/golang/src/github.com/ngalayko/talks/concurrency/examples/download/downloader/race/downloader.go:35 +0x123
  main.run()
      /Users/nikitagalaiko/golang/src/github.com/ngalayko/talks/concurrency/examples/download/cmd/download/main.go:71 +0x8e
  main.main()
      /Users/nikitagalaiko/golang/src/github.com/ngalayko/talks/concurrency/examples/download/cmd/download/main.go:56 +0x3b4

Goroutine 262 (finished) created at:
  github.com/ngalayko/talks/concurrency/examples/download/downloader/race.(*Downloader).Download()
      /Users/nikitagalaiko/golang/src/github.com/ngalayko/talks/concurrency/examples/download/downloader/race/downloader.go:35 +0x123
  main.run()
      /Users/nikitagalaiko/golang/src/github.com/ngalayko/talks/concurrency/examples/download/cmd/download/main.go:71 +0x8e
  main.main()
      /Users/nikitagalaiko/golang/src/github.com/ngalayko/talks/concurrency/examples/download/cmd/download/main.go:56 +0x3b4
==================
</code></pre><p>I&rsquo;ve built the code with <code>-race</code> flag to enable golang race detector and got a
warning about the data race. Of cource, a warning is not an error, and we can
ignore it, the result was correct: we&rsquo;ve downloaded a page for each link.</p><p>But why race detector does not agree?</p><p>First, let&rsquo;s see what lines he doesn&rsquo;t like:</p><div class=highlight><pre class=chroma><code class=language-go data-lang=go>    <span class=nx>result</span><span class=p>[</span><span class=nx>u</span><span class=p>]</span> <span class=p>=</span> <span class=nx>data</span>
</code></pre></div><p>A map is a data structure that contains keys and values. All keys are unique,
and each key has an associated value with it. For the sake of the example
let&rsquo;s say that every key is associated with a particular address in the memory,
and the address is permanent.</p><p>So when we are updating the key&rsquo;s value, we are updating data at the same address
in the memory.</p><p>In our example, we have unique urls, we download each of them and place the content
to the individual memory address associated with a map key.</p><p>But what should happen when we write different data into the same key? If we
follow the abstractions of a map that I&rsquo;ve described above and goroutines -
light-weight threads that are running concurrently at the same time - then the
final value for the map is not determined.</p><p>Because what happens is that we are telling go to write some data at the same
memory address multiple times at the same time. This can cause all kinds of
problems - from the unexpected result for a programmer to data corruption. And it&rsquo;s
not a responsibility of a language to decide what does a programmer wants to see
as a result. And a result in the situation depends on uncontrollable events.</p><p>That&rsquo;s why go gives us a warning. It can&rsquo;t guarantee the result.</p><p>It doesn&rsquo;t apply only to maps. The same can happen when you share a pointer
between two goroutines. Or you are writing to the same file from two different
programmes, or maybe you are saving data from two instances of your applications to
the same database. These all are different kinds of the same problem.</p><blockquote><p>Data races happen only when you have multiple threads/goroutines/processes that
can access the same data at the same time.</p></blockquote><p>Likely, that problem was around for a while, and there is a solution to it.</p><blockquote><p>You need to make sure that only one process has access to the same piece of
memory at a time.</p></blockquote><p>Though, there is a difference between write and read access. Reading the same
data from multiple threads is safe. The problems start only when you have
a thread that writes.</p><p>Golang has a few instruments to deal with data races like mutexes and channels.</p><p>Mutexes are used to solve exactly data race problems, here how to use them:</p><div class=highlight><pre class=chroma><code class=language-go data-lang=go><span class=kd>func</span> <span class=p>(</span><span class=nx>d</span> <span class=o>*</span><span class=nx>Downloader</span><span class=p>)</span> <span class=nf>Download</span><span class=p>(</span><span class=nx>urls</span> <span class=o>...*</span><span class=nx>url</span><span class=p>.</span><span class=nx>URL</span><span class=p>)</span> <span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=o>*</span><span class=nx>url</span><span class=p>.</span><span class=nx>URL</span><span class=p>][]</span><span class=kt>byte</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
	<span class=nx>result</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=o>*</span><span class=nx>url</span><span class=p>.</span><span class=nx>URL</span><span class=p>][]</span><span class=kt>byte</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=nx>urls</span><span class=p>))</span>
	<span class=nx>wg</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>sync</span><span class=p>.</span><span class=nx>WaitGroup</span><span class=p>{}</span>

	<span class=nx>guard</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>sync</span><span class=p>.</span><span class=nx>Mutex</span><span class=p>{}</span>

	<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>u</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>urls</span> <span class=p>{</span>
		<span class=nx>wg</span><span class=p>.</span><span class=nf>Add</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
		<span class=k>go</span> <span class=kd>func</span><span class=p>(</span><span class=nx>u</span> <span class=o>*</span><span class=nx>url</span><span class=p>.</span><span class=nx>URL</span><span class=p>)</span> <span class=p>{</span>
			<span class=nx>data</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>d</span><span class=p>.</span><span class=nf>download</span><span class=p>(</span><span class=nx>u</span><span class=p>)</span>

			<span class=nx>guard</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
			<span class=nx>result</span><span class=p>[</span><span class=nx>u</span><span class=p>]</span> <span class=p>=</span> <span class=nx>data</span>
			<span class=nx>guard</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>

			<span class=nx>wg</span><span class=p>.</span><span class=nf>Done</span><span class=p>()</span>
		<span class=p>}(</span><span class=nx>u</span><span class=p>)</span>
	<span class=p>}</span>
	<span class=nx>wg</span><span class=p>.</span><span class=nf>Wait</span><span class=p>()</span>
	<span class=k>return</span> <span class=nx>result</span><span class=p>,</span> <span class=kc>nil</span>
<span class=p>}</span>
</code></pre></div><p>It has two methods, <code>Lock</code> and <code>Unlock</code>. Everything between them can be accessed
only by one goroutine at a time. Others will wait for the mutex to unlock before
they can access it.</p><p>Channels are a bit more tricky, and can be also used to controll goroutines:</p><div class=highlight><pre class=chroma><code class=language-go data-lang=go><span class=kd>type</span> <span class=nx>done</span> <span class=kd>struct</span> <span class=p>{</span>
	<span class=nx>u</span>    <span class=o>*</span><span class=nx>url</span><span class=p>.</span><span class=nx>URL</span>
	<span class=nx>data</span> <span class=p>[]</span><span class=kt>byte</span>
	<span class=nx>err</span>  <span class=kt>error</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=p>(</span><span class=nx>d</span> <span class=o>*</span><span class=nx>Downloader</span><span class=p>)</span> <span class=nf>Download</span><span class=p>(</span><span class=nx>urls</span> <span class=o>...*</span><span class=nx>url</span><span class=p>.</span><span class=nx>URL</span><span class=p>)</span> <span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=o>*</span><span class=nx>url</span><span class=p>.</span><span class=nx>URL</span><span class=p>][]</span><span class=kt>byte</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
	<span class=nx>result</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=o>*</span><span class=nx>url</span><span class=p>.</span><span class=nx>URL</span><span class=p>][]</span><span class=kt>byte</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=nx>urls</span><span class=p>))</span>

	<span class=nx>doneChan</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=o>*</span><span class=nx>done</span><span class=p>)</span>

	<span class=nx>wg</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>sync</span><span class=p>.</span><span class=nx>WaitGroup</span><span class=p>{}</span>
	<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>u</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>urls</span> <span class=p>{</span>
		<span class=nx>wg</span><span class=p>.</span><span class=nf>Add</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
		<span class=k>go</span> <span class=kd>func</span><span class=p>(</span><span class=nx>u</span> <span class=o>*</span><span class=nx>url</span><span class=p>.</span><span class=nx>URL</span><span class=p>)</span> <span class=p>{</span>
			<span class=nx>data</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>d</span><span class=p>.</span><span class=nf>download</span><span class=p>(</span><span class=nx>u</span><span class=p>)</span>
			<span class=nx>doneChan</span> <span class=o>&lt;-</span> <span class=o>&amp;</span><span class=nx>done</span><span class=p>{</span>
				<span class=nx>u</span><span class=p>:</span>    <span class=nx>u</span><span class=p>,</span>
				<span class=nx>data</span><span class=p>:</span> <span class=nx>data</span><span class=p>,</span>
				<span class=nx>err</span><span class=p>:</span>  <span class=nx>err</span><span class=p>,</span>
			<span class=p>}</span>
			<span class=nx>wg</span><span class=p>.</span><span class=nf>Done</span><span class=p>()</span>
		<span class=p>}(</span><span class=nx>u</span><span class=p>)</span>
	<span class=p>}</span>

	<span class=k>go</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
		<span class=nx>wg</span><span class=p>.</span><span class=nf>Wait</span><span class=p>()</span>
		<span class=nb>close</span><span class=p>(</span><span class=nx>doneChan</span><span class=p>)</span>
	<span class=p>}()</span>

	<span class=k>for</span> <span class=nx>done</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>doneChan</span> <span class=p>{</span>
		<span class=k>if</span> <span class=nx>done</span><span class=p>.</span><span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
			<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;error downloading %s: %s&#34;</span><span class=p>,</span> <span class=nx>done</span><span class=p>.</span><span class=nx>u</span><span class=p>,</span> <span class=nx>done</span><span class=p>.</span><span class=nx>err</span><span class=p>)</span>
		<span class=p>}</span>
		<span class=nx>result</span><span class=p>[</span><span class=nx>done</span><span class=p>.</span><span class=nx>u</span><span class=p>]</span> <span class=p>=</span> <span class=nx>done</span><span class=p>.</span><span class=nx>data</span>
	<span class=p>}</span>

	<span class=k>return</span> <span class=nx>result</span><span class=p>,</span> <span class=kc>nil</span>
<span class=p>}</span>
</code></pre></div><p>Data from the multiple goroutines sent to the single goroutine via a channel and
that goroutine stores the data in the map.</p><h2 id=links>Links:<a href=#links class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><ul><li><a href=https://github.com/ngalayko/examples/tree/master/concurrency/examples/download>example</a></li></ul></div><div class="related-posts thin"><h2>See Also</h2><ul><li><a href=/posts/blog/optimizing-functions/>Optimizing a function</a></li><li><a href=/posts/dcp/maze/>Daily Coding Problem #23</a></li><li><a href=/posts/probability/>Daily Coding Problem #15</a></li><li><a href=/posts/dcp/probability/>Daily Coding Problem #15</a></li><li><a href=/posts/dcp/boring/>Daily Coding Problem: Boring</a></li></ul></div><hr class=post-end><footer class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=tag><a href=https://galaiko.rocks/tags/go>go</a></span><span class=tag><a href=https://galaiko.rocks/tags/data-race>data race</a></span><span class=tag><a href=https://galaiko.rocks/tags/race-condition>race condition</a></span></p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>1169 Words</p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>2019-02-02 00:00 +0000</p></footer></article><div class="post-nav thin"><a class=next-post href=https://galaiko.rocks/posts/blog/peer-to-peer/><span class=post-nav-label><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>&nbsp;Newer</span><br><span>Building a peer to peer messenger</span></a>
<a class=prev-post href=https://galaiko.rocks/posts/blog/optimizing-functions/><span class=post-nav-label>Older&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg></span><br><span>Optimizing a function</span></a></div><div id=comments class=thin></div></main><footer id=site-footer class="section-inner thin animated fadeIn faster"><p>&copy; 2021 <a href=https://galaiko.rocks>Nikita Galaiko</a> &#183; <a href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank rel=noopener>CC BY-NC 4.0</a></p><p>Made with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> &#183; Theme <a href=https://github.com/Track3/hermit target=_blank rel=noopener>Hermit</a> &#183; <a href=https://galaiko.rocks/posts/index.xml target=_blank title=rss><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></p></footer><script src=https://galaiko.rocks/js/bundle.min.7d8545daa55d62427355498dd8da13f98ff79a7938ce7d2a5e2ae1ec0de3beb8.js integrity="sha256-fYVF2qVdYkJzVUmN2NoT+Y/3mnk4zn0qXirh7A3jvrg=" crossorigin=anonymous></script></body></html>
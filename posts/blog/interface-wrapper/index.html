<!doctype html><html><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Nikita Galaiko"><title>Forced wrapper interface</title><link rel="shortcut icon" href=https://galaiko.rocks/favicon.ico><style>*,*:before,*:after{box-sizing:border-box}body{font-size:20px;line-height:28px;font-family:helvetica neue,arial,sans-serif;width:100%;margin:0 auto;padding:0 16px}@media(min-width:770px){body{width:800px}}header#banner{margin:25px 0}header#banner a{text-decoration:none}header#banner a:hover{text-decoration:underline}header#banner h2{display:inline;margin:0 8px 0 0;font-size:1em}header#banner nav{display:inline-block}header#banner nav ul{list-style-type:none;text-transform:lowercase;margin:0;padding:0}header#banner nav ul li{display:inline;margin:0 3px}main#content a{text-decoration:none}main#content a:hover{text-decoration:underline}main#content h1,main#content h2,main#content h3,main#content h4,main#content h5,main#content h6{margin-bottom:0}main#content h2{font-size:21.4px;line-height:28px;margin:28px 0 0}main#content h1+p,main#content h3+p,main#content h4+p,main#content h5+p,main#content h6+p{margin-top:5px}main#content p{margin:16px 0}main#content hr{height:1px;border:0}main#content ul#posts{list-style-type:none;margin-top:0;padding:0}main#content ul#posts li{margin:5px 0;padding:0}main#content ul#posts small{font-size:.8em;margin-left:10px}main#content ul#posts li a{text-decoration:none}main#content header#post-header h1{display:block;font-size:1.95552em;line-height:1.2141em}main#content header#post-header div{display:block;font-size:.8em;font-weight:300}main#content img{max-width:100%;margin:0 auto}main#content figure{margin:16px 0}main#content figure img{display:block;max-width:100%;margin:0 auto}main#content figure figcaption{font-size:.92em;font-style:italic;line-height:22px;text-align:center;margin-top:6px;padding:0 10px}main#content figure figcaption h4{font-style:normal;display:inline;margin:0}main#content figure figcaption p{display:inline;margin:0;padding-left:8px}main#content blockquote{font-style:italic;margin-top:10px;margin-bottom:10px;margin-left:50px;padding-left:15px;border-left:3px solid #ccc}main#content code,main#content pre{font-family:menlo,monospace}main#content code{font-size:.87em;line-height:1.45em}main#content pre{display:block;overflow-x:auto;white-space:pre}main#content section.footnotes{font-size:.9em}footer#footer{margin:40px 0;font-size:.8em;font-weight:300}html{scrollbar-color:#6c6c6c #2e2e2e}body{color:#282828;background:#fbf1c7}header#banner a{color:#282828}header#banner nav ul li a{color:#504945}main#content a{color:#076678}main#content p{color:#3c3836}main#content hr{background:#d8d8d8}main#content ul#posts small{color:#7c6f64}main#content ul#posts li a:hover{color:#458588}main#content header#post-header div{color:#7c6f64}@media(prefers-color-scheme:dark){html{scrollbar-color:#6c6c6c #2e2e2e}body{color:#fbf1c7;background:#282828}header#banner a{color:#fbf1c7}header#banner nav ul li a{color:#d5c4a1}main#content a{color:#83a598}main#content p{color:#ebdbb2}main#content hr{background:#5c5c5c}main#content ul#posts small{color:#a89984}main#content ul#posts li a:hover{color:#458588}main#content header#post-header div{color:#a89984}}</style></head><body><header id=banner><h2><a href=https://galaiko.rocks>Nikita Galaiko</a></h2><nav><ul><li><a href=/posts/ title>Posts</a></li><li><a href=/about/ title>About</a></li><li><a href=/posts/index.xml title>RSS</a></li></ul></nav></header><main id=content><article><header id=post-header><h1>Forced wrapper interface</h1><div><time>March 24, 2019</time></div></header><p>Let&rsquo;s take this interface as an example:</p><div class=highlight><pre class=chroma><code class=language-go data-lang=go><span class=kd>type</span> <span class=nx>Block</span> <span class=kd>interface</span> <span class=p>{</span>
    <span class=nf>Chain</span><span class=p>(</span><span class=nx>Block</span><span class=p>)</span> <span class=p>(</span><span class=kt>string</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span>
<span class=p>}</span>
</code></pre></div><p>I want to make sure that input <code>Block</code> is always valid, and the output string is never empty if the error is
<code>nil</code>. How can I do that? There are a couple of options.</p><p>The first option is to rely on every implementation to validate it, but it means a boilerplate code that is easy
to miss.</p><p>Another option is to create another layer and move all of the logic there. Something like:</p><div class=highlight><pre class=chroma><code class=language-go data-lang=go><span class=kd>type</span> <span class=nx>Chain</span> <span class=kd>interface</span> <span class=p>{</span>
    <span class=nf>Add</span><span class=p>(</span><span class=nx>Block</span><span class=p>)</span> <span class=kt>error</span>
<span class=p>}</span>

<span class=kd>type</span> <span class=nx>Block</span> <span class=kd>interface</span> <span class=p>{</span>
    <span class=nf>Hash</span><span class=p>()</span> <span class=kt>string</span>
<span class=p>}</span>
</code></pre></div><p>It&rsquo;s better, but I don&rsquo;t want to create another entity.</p><p>I can also create an implementation that wraps all other implementations and does all the checks:</p><div class=highlight><pre class=chroma><code class=language-go data-lang=go><span class=kd>type</span> <span class=nx>check</span> <span class=kd>struct</span> <span class=p>{</span>
    <span class=nx>i</span> <span class=nx>block</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=nf>Check</span><span class=p>(</span><span class=nx>i</span> <span class=nx>Block</span><span class=p>)</span> <span class=o>*</span><span class=nx>check</span> <span class=p>{</span>
    <span class=k>return</span> <span class=o>&amp;</span><span class=nx>check</span><span class=p>{</span>
        <span class=nx>i</span><span class=p>:</span> <span class=nx>i</span><span class=p>,</span>
    <span class=p>}</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>check</span><span class=p>)</span> <span class=nf>Chain</span><span class=p>(</span><span class=nx>b</span> <span class=nx>Block</span><span class=p>)</span> <span class=p>(</span><span class=kt>string</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
    <span class=nx>hash</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nx>i</span><span class=p>.</span><span class=nf>Chain</span><span class=p>(</span><span class=nx>b</span><span class=p>)</span>

    <span class=k>if</span> <span class=nx>hash</span> <span class=o>==</span> <span class=s>&#34;&#34;</span> <span class=o>&amp;&amp;</span> <span class=nx>err</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
        <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;err is nil, and hash is empty, do something here.&#34;</span><span class=p>)</span>
    <span class=p>}</span>

    <span class=k>return</span> <span class=nx>hash</span><span class=p>,</span> <span class=nx>err</span>
<span class=p>}</span>
</code></pre></div><p>There is still the same problem: it&rsquo;s easy to forget to wrap a custom implementation into the check and skip
validation.</p><p>Likely, I found a way to enforce it during the build time. To do that, <code>Block</code> interface and the <code>check</code>
implementation should be slightly changed:</p><div class=highlight><pre class=chroma><code class=language-go data-lang=go><span class=kd>type</span> <span class=nx>block</span> <span class=kd>interface</span> <span class=p>{</span>
    <span class=nf>Chain</span><span class=p>(</span><span class=nx>Block</span><span class=p>)</span> <span class=p>(</span><span class=kt>string</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span>
<span class=p>}</span>

<span class=kd>type</span> <span class=nx>Block</span> <span class=kd>interface</span> <span class=p>{</span>
    <span class=nx>block</span>

    <span class=nf>p</span><span class=p>()</span>
<span class=p>}</span>
</code></pre></div><div class=highlight><pre class=chroma><code class=language-go data-lang=go><span class=kd>func</span> <span class=nf>Check</span><span class=p>(</span><span class=nx>i</span> <span class=nx>block</span><span class=p>)</span> <span class=nx>Block</span> <span class=p>{</span>
    <span class=k>return</span> <span class=o>&amp;</span><span class=nx>check</span><span class=p>{</span>
        <span class=nx>i</span><span class=p>:</span> <span class=nx>i</span><span class=p>,</span>
    <span class=p>}</span>
<span class=p>}</span>

<span class=kd>type</span> <span class=nx>check</span> <span class=kd>struct</span> <span class=p>{</span>
    <span class=nx>i</span> <span class=nx>block</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>check</span><span class=p>)</span> <span class=nf>Chain</span><span class=p>(</span><span class=nx>b</span> <span class=nx>Block</span><span class=p>)</span> <span class=p>(</span><span class=kt>string</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
    <span class=nx>hash</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nx>i</span><span class=p>.</span><span class=nf>Chain</span><span class=p>(</span><span class=nx>b</span><span class=p>)</span>

    <span class=k>if</span> <span class=nx>hash</span> <span class=o>==</span> <span class=s>&#34;&#34;</span> <span class=o>&amp;&amp;</span> <span class=nx>err</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
        <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;err is nil, and hash is empty, do something here.&#34;</span><span class=p>)</span>
    <span class=p>}</span>

    <span class=k>return</span> <span class=nx>hash</span><span class=p>,</span> <span class=nx>err</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>check</span><span class=p>)</span> <span class=nf>p</span><span class=p>()</span> <span class=p>{}</span>
</code></pre></div><p>Now, it&rsquo;s impossible to implement <code>Block</code> interface, because there is no way to implement a private method.</p><p>The only way to do that is to implement all public methods and call <code>Check</code> function.</p><p>You can find full example code on <a href=https://github.com/ngalayko/examples/tree/master/protection>GitHub</a></p></article></main><footer id=footer><style>a{color:inherit;text-decoration:none}a:hover{text-decoration:underline}</style>&copy; 2018...2021
<a href=https://galaiko.rocks>Nikita Galaiko</a>
&#183; <a href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank rel=noopener>CC BY-NC 4.0</a></footer></body></html>
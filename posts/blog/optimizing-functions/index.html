<!doctype html><html><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Nikita Galaiko"><title>Optimizing a function</title><link rel="shortcut icon" href=https://galaiko.rocks/favicon.ico><style>*,*:before,*:after{box-sizing:border-box}body{font-size:20px;line-height:28px;font-family:helvetica neue,arial,sans-serif;width:100%;margin:0 auto;padding:0 16px}@media(min-width:770px){body{width:800px}}header#banner{margin:25px 0}header#banner a{text-decoration:none}header#banner a:hover{text-decoration:underline}header#banner h2{display:inline;margin:0 8px 0 0;font-size:1em}header#banner nav{display:inline-block}header#banner nav ul{list-style-type:none;text-transform:lowercase;margin:0;padding:0}header#banner nav ul li{display:inline;margin:0 3px}main#content a{text-decoration:none}main#content a:hover{text-decoration:underline}main#content h1,main#content h2,main#content h3,main#content h4,main#content h5,main#content h6{margin-bottom:0}main#content h2{font-size:21.4px;line-height:28px;margin:28px 0 0}main#content h1+p,main#content h3+p,main#content h4+p,main#content h5+p,main#content h6+p{margin-top:5px}main#content p{margin:16px 0}main#content hr{height:1px;border:0}main#content ul#posts{list-style-type:none;margin-top:0;padding:0}main#content ul#posts li{margin:15px 0 0;padding:0}main#content ul#posts small{font-size:.8em;margin-left:10px}main#content ul#posts li a{text-decoration:none}main#content header#post-header h1{display:block;font-size:1.95552em;line-height:1.2141em}main#content header#post-header div{display:block;font-size:.8em;font-weight:300}main#content img{max-width:100%;margin:0 auto}main#content figure{margin:16px 0}main#content figure img{display:block;max-width:100%;margin:0 auto}main#content figure figcaption{font-size:.92em;font-style:italic;line-height:22px;text-align:center;margin-top:6px;padding:0 10px}main#content figure figcaption h4{font-style:normal;display:inline;margin:0}main#content figure figcaption p{display:inline;margin:0;padding-left:8px}main#content blockquote{font-style:italic;margin-top:10px;margin-bottom:10px;margin-left:50px;padding-left:15px;border-left:3px solid #ccc}main#content code,main#content pre{font-family:menlo,monospace}main#content code{font-size:.87em;line-height:1.45em}main#content pre{display:block;overflow-x:auto;white-space:pre}main#content section.footnotes{font-size:.9em}footer#footer{margin:40px 0;font-size:.8em;font-weight:300}html{scrollbar-color:#6c6c6c #2e2e2e}body{color:#282828;background:#fbf1c7}header#banner a{color:#282828}header#banner nav ul li a{color:#504945}main#content a{color:#076678}main#content p{color:#3c3836}main#content hr{background:#d8d8d8}main#content ul#posts small{color:#7c6f64}main#content ul#posts li a:hover{color:#458588}main#content header#post-header div{color:#7c6f64}@media(prefers-color-scheme:dark){html{scrollbar-color:#6c6c6c #2e2e2e}body{color:#fbf1c7;background:#282828}header#banner a{color:#fbf1c7}header#banner nav ul li a{color:#d5c4a1}main#content a{color:#83a598}main#content p{color:#ebdbb2}main#content hr{background:#5c5c5c}main#content ul#posts small{color:#a89984}main#content ul#posts li a:hover{color:#458588}main#content header#post-header div{color:#a89984}}</style></head><body><header id=banner><h2><a href=https://galaiko.rocks>Nikita Galaiko</a></h2><nav><ul><li><a href=/posts/ title>Posts</a></li><li><a href=/about/ title>About</a></li><li><a href=/posts/index.xml title>RSS</a></li></ul></nav></header><main id=content><article><header id=post-header><h1>Optimizing a function</h1><div><time>November 30, 2018</time></div></header><p>In the golang community slack, someone shared a link to a package used to
validate Swedish personnumer. Personnumer is a swedish version of an ID, and its
format is well defined:</p><ol><li>First 6 or 8 digits is a birthrate with or without a century.</li><li>Last four digits are random secret digits.</li><li>The whole number satisfies the <a href=https://en.wikipedia.org/wiki/Luhn_algorithm>Luhn algorithm</a>.</li><li>Birthdate and secret digits can be divided with <code>-</code> or <code>+</code>.</li></ol><p>For example <code>19900101-0017</code></p><p>Here is the initial code of the package:</p><div class=highlight><pre class=chroma><code class=language-go data-lang=go><span class=kn>package</span> <span class=nx>personnummer</span>

<span class=kn>import</span> <span class=p>(</span>
	<span class=s>&#34;math&#34;</span>
	<span class=s>&#34;reflect&#34;</span>
	<span class=s>&#34;regexp&#34;</span>
	<span class=s>&#34;strconv&#34;</span>
	<span class=s>&#34;time&#34;</span>
<span class=p>)</span>

<span class=c1>// luhn will test if the given string is a valid luhn string.
</span><span class=c1></span><span class=kd>func</span> <span class=nf>luhn</span><span class=p>(</span><span class=nx>str</span> <span class=kt>string</span><span class=p>)</span> <span class=kt>int</span> <span class=p>{</span>
	<span class=nx>sum</span> <span class=o>:=</span> <span class=mi>0</span>

	<span class=k>for</span> <span class=nx>i</span><span class=p>,</span> <span class=nx>r</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>str</span> <span class=p>{</span>
		<span class=nx>c</span> <span class=o>:=</span> <span class=nb>string</span><span class=p>(</span><span class=nx>r</span><span class=p>)</span>
		<span class=nx>v</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>strconv</span><span class=p>.</span><span class=nf>Atoi</span><span class=p>(</span><span class=nx>c</span><span class=p>)</span>
		<span class=nx>v</span> <span class=o>*=</span> <span class=mi>2</span> <span class=o>-</span> <span class=p>(</span><span class=nx>i</span> <span class=o>%</span> <span class=mi>2</span><span class=p>)</span>
		<span class=k>if</span> <span class=nx>v</span> <span class=p>&gt;</span> <span class=mi>9</span> <span class=p>{</span>
			<span class=nx>v</span> <span class=o>-=</span> <span class=mi>9</span>
		<span class=p>}</span>
		<span class=nx>sum</span> <span class=o>+=</span> <span class=nx>v</span>
	<span class=p>}</span>

	<span class=k>return</span> <span class=nb>int</span><span class=p>(</span><span class=nx>math</span><span class=p>.</span><span class=nf>Ceil</span><span class=p>(</span><span class=nb>float64</span><span class=p>(</span><span class=nx>sum</span><span class=p>)</span><span class=o>/</span><span class=mi>10</span><span class=p>)</span><span class=o>*</span><span class=mi>10</span> <span class=o>-</span> <span class=nb>float64</span><span class=p>(</span><span class=nx>sum</span><span class=p>))</span>
<span class=p>}</span>

<span class=c1>// testDate will test if date is valid or not.
</span><span class=c1></span><span class=kd>func</span> <span class=nf>testDate</span><span class=p>(</span><span class=nx>century</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>year</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>month</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>day</span> <span class=kt>string</span><span class=p>)</span> <span class=kt>bool</span> <span class=p>{</span>
	<span class=nx>t</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Parse</span><span class=p>(</span><span class=s>&#34;01/02/2006&#34;</span><span class=p>,</span> <span class=nx>month</span><span class=o>+</span><span class=s>&#34;/&#34;</span><span class=o>+</span><span class=nx>day</span><span class=o>+</span><span class=s>&#34;/&#34;</span><span class=o>+</span><span class=nx>century</span><span class=o>+</span><span class=nx>year</span><span class=p>)</span>

	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
		<span class=k>return</span> <span class=kc>false</span>
	<span class=p>}</span>

	<span class=nx>y</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>strconv</span><span class=p>.</span><span class=nf>Atoi</span><span class=p>(</span><span class=nx>century</span> <span class=o>+</span> <span class=nx>year</span><span class=p>)</span>
	<span class=nx>m</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>strconv</span><span class=p>.</span><span class=nf>Atoi</span><span class=p>(</span><span class=nx>month</span><span class=p>)</span>
	<span class=nx>d</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>strconv</span><span class=p>.</span><span class=nf>Atoi</span><span class=p>(</span><span class=nx>day</span><span class=p>)</span>

	<span class=k>if</span> <span class=nx>y</span> <span class=p>&gt;</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>().</span><span class=nf>Year</span><span class=p>()</span> <span class=p>{</span>
		<span class=k>return</span> <span class=kc>false</span>
	<span class=p>}</span>

	<span class=k>return</span> <span class=p>!(</span><span class=nx>t</span><span class=p>.</span><span class=nf>Year</span><span class=p>()</span> <span class=o>!=</span> <span class=nx>y</span> <span class=o>||</span> <span class=nb>int</span><span class=p>(</span><span class=nx>t</span><span class=p>.</span><span class=nf>Month</span><span class=p>())</span> <span class=o>!=</span> <span class=nx>m</span> <span class=o>||</span> <span class=nx>t</span><span class=p>.</span><span class=nf>Day</span><span class=p>()</span> <span class=o>!=</span> <span class=nx>d</span><span class=p>)</span>
<span class=p>}</span>

<span class=c1>// getCoOrdinationDay will return co-ordination day.
</span><span class=c1></span><span class=kd>func</span> <span class=nf>getCoOrdinationDay</span><span class=p>(</span><span class=nx>day</span> <span class=kt>string</span><span class=p>)</span> <span class=kt>string</span> <span class=p>{</span>
	<span class=nx>d</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>strconv</span><span class=p>.</span><span class=nf>Atoi</span><span class=p>(</span><span class=nx>day</span><span class=p>)</span>
	<span class=nx>d</span> <span class=o>-=</span> <span class=mi>60</span>
	<span class=nx>day</span> <span class=p>=</span> <span class=nx>strconv</span><span class=p>.</span><span class=nf>Itoa</span><span class=p>(</span><span class=nx>d</span><span class=p>)</span>

	<span class=k>if</span> <span class=nx>d</span> <span class=p>&lt;</span> <span class=mi>10</span> <span class=p>{</span>
		<span class=nx>day</span> <span class=p>=</span> <span class=s>&#34;0&#34;</span> <span class=o>+</span> <span class=nx>day</span>
	<span class=p>}</span>

	<span class=k>return</span> <span class=nx>day</span>
<span class=p>}</span>

<span class=c1>// Valid will validate Swedish social security numbers.
</span><span class=c1></span><span class=kd>func</span> <span class=nf>Valid</span><span class=p>(</span><span class=nx>str</span> <span class=kd>interface</span><span class=p>{})</span> <span class=kt>bool</span> <span class=p>{</span>
	<span class=k>if</span> <span class=nx>reflect</span><span class=p>.</span><span class=nf>TypeOf</span><span class=p>(</span><span class=nx>str</span><span class=p>).</span><span class=nf>Kind</span><span class=p>()</span> <span class=o>!=</span> <span class=nx>reflect</span><span class=p>.</span><span class=nx>Int</span> <span class=o>&amp;&amp;</span> <span class=nx>reflect</span><span class=p>.</span><span class=nf>TypeOf</span><span class=p>(</span><span class=nx>str</span><span class=p>).</span><span class=nf>Kind</span><span class=p>()</span> <span class=o>!=</span> <span class=nx>reflect</span><span class=p>.</span><span class=nx>String</span> <span class=p>{</span>
		<span class=k>return</span> <span class=kc>false</span>
	<span class=p>}</span>

	<span class=nx>pr</span> <span class=o>:=</span> <span class=s>&#34;&#34;</span>

	<span class=k>if</span> <span class=nx>reflect</span><span class=p>.</span><span class=nf>TypeOf</span><span class=p>(</span><span class=nx>str</span><span class=p>).</span><span class=nf>Kind</span><span class=p>()</span> <span class=o>==</span> <span class=nx>reflect</span><span class=p>.</span><span class=nx>Int</span> <span class=p>{</span>
		<span class=nx>pr</span> <span class=p>=</span> <span class=nx>strconv</span><span class=p>.</span><span class=nf>Itoa</span><span class=p>(</span><span class=nx>str</span><span class=p>.(</span><span class=kt>int</span><span class=p>))</span>
	<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
		<span class=nx>pr</span> <span class=p>=</span> <span class=nx>str</span><span class=p>.(</span><span class=kt>string</span><span class=p>)</span>
	<span class=p>}</span>

	<span class=nx>re</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>regexp</span><span class=p>.</span><span class=nf>Compile</span><span class=p>(</span><span class=s>`^(\d{2}){0,1}(\d{2})(\d{2})(\d{2})([\-|\+]{0,1})?(\d{3})(\d{0,1})$`</span><span class=p>)</span>
	<span class=nx>match</span> <span class=o>:=</span> <span class=nx>re</span><span class=p>.</span><span class=nf>FindStringSubmatch</span><span class=p>(</span><span class=nx>pr</span><span class=p>)</span>

	<span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>match</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span>
		<span class=k>return</span> <span class=kc>false</span>
	<span class=p>}</span>

	<span class=nx>century</span> <span class=o>:=</span> <span class=nx>match</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
	<span class=nx>year</span> <span class=o>:=</span> <span class=nx>match</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span>
	<span class=nx>month</span> <span class=o>:=</span> <span class=nx>match</span><span class=p>[</span><span class=mi>3</span><span class=p>]</span>
	<span class=nx>day</span> <span class=o>:=</span> <span class=nx>match</span><span class=p>[</span><span class=mi>4</span><span class=p>]</span>
	<span class=nx>num</span> <span class=o>:=</span> <span class=nx>match</span><span class=p>[</span><span class=mi>6</span><span class=p>]</span>
	<span class=nx>check</span> <span class=o>:=</span> <span class=nx>match</span><span class=p>[</span><span class=mi>7</span><span class=p>]</span>

	<span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>century</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span>
		<span class=nx>yearNow</span> <span class=o>:=</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>().</span><span class=nf>Year</span><span class=p>()</span>
		<span class=nx>years</span> <span class=o>:=</span> <span class=p>[</span><span class=o>...</span><span class=p>]</span><span class=kt>int</span><span class=p>{</span><span class=nx>yearNow</span><span class=p>,</span> <span class=nx>yearNow</span> <span class=o>-</span> <span class=mi>100</span><span class=p>,</span> <span class=nx>yearNow</span> <span class=o>-</span> <span class=mi>150</span><span class=p>}</span>

		<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>yi</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>years</span> <span class=p>{</span>
			<span class=nx>ys</span> <span class=o>:=</span> <span class=nx>strconv</span><span class=p>.</span><span class=nf>Itoa</span><span class=p>(</span><span class=nx>yi</span><span class=p>)</span>

			<span class=k>if</span> <span class=nf>Valid</span><span class=p>(</span><span class=nx>ys</span><span class=p>[:</span><span class=mi>2</span><span class=p>]</span> <span class=o>+</span> <span class=nx>pr</span><span class=p>)</span> <span class=p>{</span>
				<span class=k>return</span> <span class=kc>true</span>
			<span class=p>}</span>
		<span class=p>}</span>

		<span class=k>return</span> <span class=kc>false</span>
	<span class=p>}</span>

	<span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>year</span><span class=p>)</span> <span class=o>==</span> <span class=mi>4</span> <span class=p>{</span>
		<span class=nx>year</span> <span class=p>=</span> <span class=nx>year</span><span class=p>[</span><span class=mi>2</span><span class=p>:]</span>
	<span class=p>}</span>

	<span class=nx>c</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>strconv</span><span class=p>.</span><span class=nf>Atoi</span><span class=p>(</span><span class=nx>check</span><span class=p>)</span>

	<span class=nx>valid</span> <span class=o>:=</span> <span class=nf>luhn</span><span class=p>(</span><span class=nx>year</span><span class=o>+</span><span class=nx>month</span><span class=o>+</span><span class=nx>day</span><span class=o>+</span><span class=nx>num</span><span class=p>)</span> <span class=o>==</span> <span class=nx>c</span> <span class=o>&amp;&amp;</span> <span class=nb>len</span><span class=p>(</span><span class=nx>check</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>0</span>

	<span class=k>if</span> <span class=nx>valid</span> <span class=o>&amp;&amp;</span> <span class=nf>testDate</span><span class=p>(</span><span class=nx>century</span><span class=p>,</span> <span class=nx>year</span><span class=p>,</span> <span class=nx>month</span><span class=p>,</span> <span class=nx>day</span><span class=p>)</span> <span class=p>{</span>
		<span class=k>return</span> <span class=nx>valid</span>
	<span class=p>}</span>

	<span class=nx>day</span> <span class=p>=</span> <span class=nf>getCoOrdinationDay</span><span class=p>(</span><span class=nx>day</span><span class=p>)</span>

	<span class=k>return</span> <span class=nx>valid</span> <span class=o>&amp;&amp;</span> <span class=nf>testDate</span><span class=p>(</span><span class=nx>century</span><span class=p>,</span> <span class=nx>year</span><span class=p>,</span> <span class=nx>month</span><span class=p>,</span> <span class=nx>day</span><span class=p>)</span>
<span class=p>}</span>
</code></pre></div><p>Let&rsquo;s add a benchmark:</p><div class=highlight><pre class=chroma><code class=language-go data-lang=go><span class=kd>func</span> <span class=nf>BenchmarkValid</span><span class=p>(</span><span class=nx>b</span> <span class=o>*</span><span class=nx>testing</span><span class=p>.</span><span class=nx>B</span><span class=p>)</span> <span class=p>{</span>
	<span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>i</span> <span class=p>&lt;</span> <span class=nx>b</span><span class=p>.</span><span class=nx>N</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span> <span class=p>{</span>
		<span class=nf>Valid</span><span class=p>(</span><span class=s>&#34;19900101-0017&#34;</span><span class=p>)</span>
	<span class=p>}</span>
<span class=p>}</span>
</code></pre></div><p>Results:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>$ go <span class=nb>test</span> -bench<span class=o>=</span>BenchmarkValid$ -benchmem
goos: darwin
goarch: amd64
pkg: github.com/ngalayko/go
BenchmarkValid-4  <span class=m>100000</span>  <span class=m>18498</span> ns/op  <span class=m>54576</span> B/op  <span class=m>118</span> allocs/op
PASS
</code></pre></div><p>That&rsquo;s a lot of resources to validate a string using four simple rules.</p><p>There are several problems in the code. I am going to remove it one by one:</p><h2 id=regexp-package>Regexp package</h2><p>The most popular way to optimize functions in go is to move the regexp compilation
out from a function:</p><div class=highlight><pre class=chroma><code class=language-go data-lang=go>
<span class=kd>var</span> <span class=p>(</span>
	<span class=nx>re</span> <span class=p>=</span> <span class=nx>regexp</span><span class=p>.</span><span class=nf>MustCompile</span><span class=p>(</span><span class=s>`^(\d{2}){0,1}(\d{2})(\d{2})(\d{2})([\-|\+]{0,1})?(\d{3})(\d{0,1})$`</span><span class=p>)</span>
<span class=p>)</span>

<span class=c1>// Valid will validate Swedish social security numbers.
</span><span class=c1></span><span class=kd>func</span> <span class=nf>Valid</span><span class=p>(</span><span class=nx>str</span> <span class=kd>interface</span><span class=p>{})</span> <span class=kt>bool</span> <span class=p>{</span>
    <span class=c1>//...
</span><span class=c1></span>
	<span class=nx>match</span> <span class=o>:=</span> <span class=nx>re</span><span class=p>.</span><span class=nf>FindStringSubmatch</span><span class=p>(</span><span class=nx>pr</span><span class=p>)</span>

	<span class=c1>//...
</span><span class=c1></span><span class=p>}</span>
</code></pre></div><p>Results are not surprising:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>$ go <span class=nb>test</span> -bench<span class=o>=</span>BenchmarkValid$ -benchmem
goos: darwin
goarch: amd64
pkg: github.com/ngalayko/go
BenchmarkValid-4  <span class=m>1000000</span>  <span class=m>1301</span> ns/op  <span class=m>309</span> B/op  <span class=m>13</span> allocs/op
PASS
</code></pre></div><h2 id=reflect-package>Reflect package</h2><p>Reflection is generally slow and is not made to be used in such cases. Here it
is used to check if the input type in <code>int</code> or <code>string</code>. Let&rsquo;s assume we actually need
a function that accepts an interface, and not just a string.</p><p>To check the type of an interface you don&rsquo;t need a reflect package. You can always
switch on an interface type:</p><div class=highlight><pre class=chroma><code class=language-go data-lang=go><span class=c1>// Valid will validate Swedish social security numbers.
</span><span class=c1></span><span class=kd>func</span> <span class=nf>Valid</span><span class=p>(</span><span class=nx>i</span> <span class=kd>interface</span><span class=p>{})</span> <span class=kt>bool</span> <span class=p>{</span>
	<span class=k>switch</span> <span class=nx>v</span> <span class=o>:=</span> <span class=nx>i</span><span class=p>.(</span><span class=kd>type</span><span class=p>)</span> <span class=p>{</span>
	<span class=k>case</span> <span class=kt>int</span><span class=p>,</span> <span class=kt>int32</span><span class=p>,</span> <span class=kt>int64</span><span class=p>,</span> <span class=kt>uint</span><span class=p>,</span> <span class=kt>uint32</span><span class=p>,</span> <span class=kt>uint64</span><span class=p>:</span>
		<span class=k>return</span> <span class=nf>ValidString</span><span class=p>(</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprint</span><span class=p>(</span><span class=nx>v</span><span class=p>))</span>
	<span class=k>case</span> <span class=kt>string</span><span class=p>:</span>
		<span class=k>return</span> <span class=nf>ValidString</span><span class=p>(</span><span class=nx>v</span><span class=p>)</span>
	<span class=k>default</span><span class=p>:</span>
		<span class=k>return</span> <span class=kc>false</span>
	<span class=p>}</span>
<span class=p>}</span>

<span class=c1>// ValidString will validate Swedish social security numbers.
</span><span class=c1></span><span class=kd>func</span> <span class=nf>ValidString</span><span class=p>(</span><span class=nx>s</span> <span class=kt>string</span><span class=p>)</span> <span class=kt>bool</span> <span class=p>{</span>
    <span class=c1>// ...
</span><span class=c1></span><span class=p>}</span>
</code></pre></div><p>Results are pretty much the same. I think it&rsquo;s because of some compiler optimizations
where <code>switch v.(type)</code> is syntax sugar for <code>reflect.TypeOf(v)</code>, plus undercover all
objects know what types they are even when you use them as an <code>interface{}</code>.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>$ go <span class=nb>test</span> -bench<span class=o>=</span>BenchmarkValid$ -benchmem
goos: darwin
goarch: amd64
pkg: github.com/ngalayko/go
BenchmarkValid-4  <span class=m>1000000</span>  <span class=m>1305</span> ns/op  <span class=m>309</span> B/op  <span class=m>13</span> allocs/op
PASS
</code></pre></div><h2 id=regexp-package-again>Regexp package again</h2><p>Why do we even need a regexp package here? To validate that string contains only
digits and <code>-</code> or <code>-</code> regexp is an overkill.</p><p>First, we clean out everything except digits from a string and check it&rsquo;s length
because we know what that length should be (6+4 or 8+4).</p><p>To check if a character is a digit, it&rsquo;s enough to make sure that it&rsquo;s greater than
<code>'0'</code> and less than <code>'9'</code>, because all digits have sequential codes in the
(ASCII table)[http://www.asciitable.com/].</p><div class=highlight><pre class=chroma><code class=language-go data-lang=go><span class=kd>func</span> <span class=nf>ValidString</span><span class=p>(</span><span class=nx>s</span> <span class=kt>string</span><span class=p>)</span> <span class=kt>bool</span> <span class=p>{</span>
	<span class=nx>cleanNumber</span> <span class=o>:=</span> <span class=s>&#34;&#34;</span>
	<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>c</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>s</span> <span class=p>{</span>
		<span class=k>if</span> <span class=nx>c</span> <span class=o>==</span> <span class=sc>&#39;+&#39;</span> <span class=p>{</span> <span class=c1>// `+` is allowed, but we don&#39;t need it.
</span><span class=c1></span>			<span class=k>continue</span>
		<span class=p>}</span>
		<span class=k>if</span> <span class=nx>c</span> <span class=o>==</span> <span class=sc>&#39;-&#39;</span> <span class=p>{</span> <span class=c1>// `-` is allowed, but we don&#39;t need it.
</span><span class=c1></span>		    <span class=k>continue</span>
        <span class=p>}</span>

		<span class=k>if</span> <span class=nx>c</span> <span class=p>&gt;</span> <span class=sc>&#39;9&#39;</span> <span class=p>{</span>
			<span class=k>return</span> <span class=kc>false</span>
		<span class=p>}</span>
		<span class=k>if</span> <span class=nx>c</span> <span class=p>&lt;</span> <span class=sc>&#39;0&#39;</span> <span class=p>{</span>
			<span class=k>return</span> <span class=kc>false</span>
		<span class=p>}</span>

		<span class=nx>cleanNumber</span> <span class=o>+=</span> <span class=nb>string</span><span class=p>(</span><span class=nx>c</span><span class=p>)</span>
	<span class=p>}</span>
    <span class=c1>//...
</span><span class=c1></span><span class=p>}</span>
</code></pre></div><p>And once we have a string that has only digits, it&rsquo;s easy to get all parts of it:</p><div class=highlight><pre class=chroma><code class=language-go data-lang=go>	<span class=c1>//...
</span><span class=c1></span>
    <span class=kd>var</span> <span class=p>(</span>
		<span class=nx>century</span> <span class=kt>string</span>
		<span class=nx>year</span>    <span class=kt>string</span>
		<span class=nx>month</span>   <span class=kt>string</span>
		<span class=nx>day</span>     <span class=kt>string</span>
		<span class=nx>num</span>     <span class=kt>string</span>
		<span class=nx>check</span>   <span class=kt>string</span>
	<span class=p>)</span>

	<span class=k>switch</span> <span class=nb>len</span><span class=p>(</span><span class=nx>cleanNumber</span><span class=p>)</span> <span class=p>{</span>
	<span class=k>case</span> <span class=mi>10</span><span class=p>:</span>
		<span class=nx>year</span> <span class=p>=</span> <span class=nb>string</span><span class=p>(</span><span class=nx>cleanNumber</span><span class=p>[:</span><span class=mi>2</span><span class=p>])</span>
		<span class=nx>month</span> <span class=p>=</span> <span class=nb>string</span><span class=p>(</span><span class=nx>cleanNumber</span><span class=p>[</span><span class=mi>2</span><span class=p>:</span><span class=mi>4</span><span class=p>])</span>
		<span class=nx>day</span> <span class=p>=</span> <span class=nb>string</span><span class=p>(</span><span class=nx>cleanNumber</span><span class=p>[</span><span class=mi>4</span><span class=p>:</span><span class=mi>6</span><span class=p>])</span>
		<span class=nx>num</span> <span class=p>=</span> <span class=nb>string</span><span class=p>(</span><span class=nx>cleanNumber</span><span class=p>[</span><span class=mi>6</span><span class=p>:</span><span class=mi>9</span><span class=p>])</span>
		<span class=nx>check</span> <span class=p>=</span> <span class=nb>string</span><span class=p>(</span><span class=nx>cleanNumber</span><span class=p>[</span><span class=mi>9</span><span class=p>:])</span>
	<span class=k>case</span> <span class=mi>12</span><span class=p>:</span>
		<span class=nx>century</span> <span class=p>=</span> <span class=nb>string</span><span class=p>(</span><span class=nx>cleanNumber</span><span class=p>[:</span><span class=mi>2</span><span class=p>])</span>
		<span class=nx>year</span> <span class=p>=</span> <span class=nb>string</span><span class=p>(</span><span class=nx>cleanNumber</span><span class=p>[</span><span class=mi>2</span><span class=p>:</span><span class=mi>4</span><span class=p>])</span>
		<span class=nx>month</span> <span class=p>=</span> <span class=nb>string</span><span class=p>(</span><span class=nx>cleanNumber</span><span class=p>[</span><span class=mi>4</span><span class=p>:</span><span class=mi>6</span><span class=p>])</span>
		<span class=nx>day</span> <span class=p>=</span> <span class=nb>string</span><span class=p>(</span><span class=nx>cleanNumber</span><span class=p>[</span><span class=mi>6</span><span class=p>:</span><span class=mi>8</span><span class=p>])</span>
		<span class=nx>num</span> <span class=p>=</span> <span class=nb>string</span><span class=p>(</span><span class=nx>cleanNumber</span><span class=p>[</span><span class=mi>8</span><span class=p>:</span><span class=mi>11</span><span class=p>])</span>
		<span class=nx>check</span> <span class=p>=</span> <span class=nb>string</span><span class=p>(</span><span class=nx>cleanNumber</span><span class=p>[</span><span class=mi>11</span><span class=p>:])</span>
	<span class=k>default</span><span class=p>:</span>
		<span class=k>return</span> <span class=kc>false</span>
	<span class=p>}</span>

    <span class=c1>//...
</span></code></pre></div><p>Results are a bit better:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>$ go <span class=nb>test</span> -bench<span class=o>=</span>BenchmarkValid$ -benchmem
goos: darwin
goarch: amd64
pkg: github.com/ngalayko/go
BenchmarkValid-4  <span class=m>1000000</span>  <span class=m>1302</span> ns/op  <span class=m>208</span> B/op  <span class=m>34</span> allocs/op
PASS
</code></pre></div><h2 id=time-package>Time package</h2><p>Standard time package is great, but what we need here is just simple validation
of a date:</p><div class=highlight><pre class=chroma><code class=language-go data-lang=go><span class=kd>var</span> <span class=nx>monthDays</span> <span class=p>=</span> <span class=kd>map</span><span class=p>[</span><span class=kt>int</span><span class=p>]</span><span class=kt>int</span><span class=p>{</span>
	<span class=mi>1</span><span class=p>:</span>  <span class=mi>31</span><span class=p>,</span>
	<span class=mi>3</span><span class=p>:</span>  <span class=mi>31</span><span class=p>,</span>
	<span class=mi>4</span><span class=p>:</span>  <span class=mi>30</span><span class=p>,</span>
	<span class=mi>5</span><span class=p>:</span>  <span class=mi>31</span><span class=p>,</span>
	<span class=mi>6</span><span class=p>:</span>  <span class=mi>30</span><span class=p>,</span>
	<span class=mi>7</span><span class=p>:</span>  <span class=mi>31</span><span class=p>,</span>
	<span class=mi>8</span><span class=p>:</span>  <span class=mi>31</span><span class=p>,</span>
	<span class=mi>9</span><span class=p>:</span>  <span class=mi>30</span><span class=p>,</span>
	<span class=mi>10</span><span class=p>:</span> <span class=mi>31</span><span class=p>,</span>
	<span class=mi>11</span><span class=p>:</span> <span class=mi>30</span><span class=p>,</span>
	<span class=mi>12</span><span class=p>:</span> <span class=mi>31</span><span class=p>,</span>
<span class=p>}</span>

<span class=c1>// testDate will test if date is valid or not.
</span><span class=c1></span><span class=kd>func</span> <span class=nf>testDate</span><span class=p>(</span><span class=nx>century</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>year</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>month</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>day</span> <span class=kt>string</span><span class=p>)</span> <span class=kt>bool</span> <span class=p>{</span>
	<span class=nx>y</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>strconv</span><span class=p>.</span><span class=nf>Atoi</span><span class=p>(</span><span class=nx>century</span> <span class=o>+</span> <span class=nx>year</span><span class=p>)</span>
	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
		<span class=k>return</span> <span class=kc>false</span>
	<span class=p>}</span>
	<span class=nx>m</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>strconv</span><span class=p>.</span><span class=nf>Atoi</span><span class=p>(</span><span class=nx>month</span><span class=p>)</span>
	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
		<span class=k>return</span> <span class=kc>false</span>
	<span class=p>}</span>
	<span class=nx>d</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>strconv</span><span class=p>.</span><span class=nf>Atoi</span><span class=p>(</span><span class=nx>day</span><span class=p>)</span>
	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
		<span class=k>return</span> <span class=kc>false</span>
	<span class=p>}</span>

	<span class=k>if</span> <span class=nx>m</span> <span class=o>!=</span> <span class=mi>2</span> <span class=p>{</span>
		<span class=nx>days</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>monthDays</span><span class=p>[</span><span class=nx>m</span><span class=p>]</span>
		<span class=k>if</span> <span class=p>!</span><span class=nx>ok</span> <span class=p>{</span>
			<span class=k>return</span> <span class=kc>false</span>
		<span class=p>}</span>
		<span class=k>return</span> <span class=nx>d</span> <span class=o>&lt;=</span> <span class=nx>days</span>
	<span class=p>}</span>

	<span class=nx>leapYear</span> <span class=o>:=</span> <span class=nx>y</span><span class=o>%</span><span class=mi>4</span> <span class=o>==</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=nx>y</span><span class=o>%</span><span class=mi>100</span> <span class=o>!=</span> <span class=mi>0</span> <span class=o>||</span> <span class=nx>y</span><span class=o>%</span><span class=mi>400</span> <span class=o>==</span> <span class=mi>0</span>

	<span class=k>if</span> <span class=nx>leapYear</span> <span class=p>{</span>
		<span class=k>return</span> <span class=nx>d</span> <span class=o>&lt;=</span> <span class=mi>29</span>
	<span class=p>}</span>
	<span class=k>return</span> <span class=nx>d</span> <span class=o>&lt;=</span> <span class=mi>28</span>
<span class=p>}</span>
</code></pre></div><p>Benchmark:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>$ go <span class=nb>test</span> -bench<span class=o>=</span>BenchmarkValid$ -benchmem
goos: darwin
goarch: amd64
pkg: github.com/ngalayko/go
BenchmarkValid-4   <span class=m>2000000</span>  <span class=m>901</span> ns/op  <span class=m>192</span> B/op  <span class=m>33</span> allocs/op
PASS
</code></pre></div><h2 id=strings>Strings</h2><p>Notice that there are still 33 allocations per function call. Where do they come
from? It&rsquo;s because we use <code>string</code> type all the time, <code>string</code> is the same thing
as a <code>[]byte</code>, but immutable. So every time we call <code>cleanNumber += string(c)</code>,
allocation happens. It&rsquo;s impossible to change the string, so new the string is allocated,
and both strings are copies there.</p><p>Let&rsquo;s remove <code>string</code> usage:</p><div class=highlight><pre class=chroma><code class=language-go data-lang=go><span class=kn>package</span> <span class=nx>personnummer</span>

<span class=kn>import</span> <span class=s>&#34;fmt&#34;</span>

<span class=kd>const</span> <span class=p>(</span>
	<span class=nx>lengthWithoutCentury</span> <span class=p>=</span> <span class=mi>10</span>
	<span class=nx>lengthWithCentury</span>    <span class=p>=</span> <span class=mi>12</span>
<span class=p>)</span>

<span class=c1>// ValidateStrings validate Swedish social security numbers.
</span><span class=c1></span><span class=kd>func</span> <span class=nf>ValidString</span><span class=p>(</span><span class=nx>in</span> <span class=kt>string</span><span class=p>)</span> <span class=kt>bool</span> <span class=p>{</span>
	<span class=nx>cleanNumber</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>([]</span><span class=kt>byte</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=nx>in</span><span class=p>))</span>
	<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>c</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>in</span> <span class=p>{</span>
		<span class=k>if</span> <span class=nx>c</span> <span class=o>==</span> <span class=sc>&#39;+&#39;</span> <span class=p>{</span>
			<span class=k>continue</span>
		<span class=p>}</span>
		<span class=k>if</span> <span class=nx>c</span> <span class=o>==</span> <span class=sc>&#39;-&#39;</span> <span class=p>{</span>
			<span class=k>continue</span>
		<span class=p>}</span>

		<span class=k>if</span> <span class=nx>c</span> <span class=p>&gt;</span> <span class=sc>&#39;9&#39;</span> <span class=p>{</span>
			<span class=k>return</span> <span class=kc>false</span>
		<span class=p>}</span>
		<span class=k>if</span> <span class=nx>c</span> <span class=p>&lt;</span> <span class=sc>&#39;0&#39;</span> <span class=p>{</span>
			<span class=k>return</span> <span class=kc>false</span>
		<span class=p>}</span>

		<span class=nx>cleanNumber</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>cleanNumber</span><span class=p>,</span> <span class=nb>byte</span><span class=p>(</span><span class=nx>c</span><span class=p>))</span>
	<span class=p>}</span>

	<span class=k>switch</span> <span class=nb>len</span><span class=p>(</span><span class=nx>cleanNumber</span><span class=p>)</span> <span class=p>{</span>
	<span class=k>case</span> <span class=nx>lengthWithCentury</span><span class=p>:</span>
		<span class=k>if</span> <span class=p>!</span><span class=nf>luhn</span><span class=p>(</span><span class=nx>cleanNumber</span><span class=p>[</span><span class=mi>2</span><span class=p>:])</span> <span class=p>{</span>
			<span class=k>return</span> <span class=kc>false</span>
		<span class=p>}</span>

		<span class=nx>dateBytes</span> <span class=o>:=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>cleanNumber</span><span class=p>[:</span><span class=mi>6</span><span class=p>],</span> <span class=nf>getCoOrdinationDay</span><span class=p>(</span><span class=nx>cleanNumber</span><span class=p>[</span><span class=mi>6</span><span class=p>:</span><span class=mi>8</span><span class=p>])</span><span class=o>...</span><span class=p>)</span>
		<span class=k>return</span> <span class=nf>validateTime</span><span class=p>(</span><span class=nx>dateBytes</span><span class=p>)</span>
	<span class=k>case</span> <span class=nx>lengthWithoutCentury</span><span class=p>:</span>
		<span class=k>if</span> <span class=p>!</span><span class=nf>luhn</span><span class=p>(</span><span class=nx>cleanNumber</span><span class=p>)</span> <span class=p>{</span>
			<span class=k>return</span> <span class=kc>false</span>
		<span class=p>}</span>

		<span class=nx>dateBytes</span> <span class=o>:=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>cleanNumber</span><span class=p>[:</span><span class=mi>4</span><span class=p>],</span> <span class=nf>getCoOrdinationDay</span><span class=p>(</span><span class=nx>cleanNumber</span><span class=p>[</span><span class=mi>4</span><span class=p>:</span><span class=mi>6</span><span class=p>])</span><span class=o>...</span><span class=p>)</span>
		<span class=k>return</span> <span class=nf>validateTime</span><span class=p>(</span><span class=nx>dateBytes</span><span class=p>)</span>
	<span class=k>default</span><span class=p>:</span>
		<span class=k>return</span> <span class=kc>false</span>
	<span class=p>}</span>
<span class=p>}</span>

<span class=kd>var</span> <span class=nx>monthDays</span> <span class=p>=</span> <span class=kd>map</span><span class=p>[</span><span class=kt>int</span><span class=p>]</span><span class=kt>int</span><span class=p>{</span>
	<span class=mi>1</span><span class=p>:</span>  <span class=mi>31</span><span class=p>,</span>
	<span class=mi>3</span><span class=p>:</span>  <span class=mi>31</span><span class=p>,</span>
	<span class=mi>4</span><span class=p>:</span>  <span class=mi>30</span><span class=p>,</span>
	<span class=mi>5</span><span class=p>:</span>  <span class=mi>31</span><span class=p>,</span>
	<span class=mi>6</span><span class=p>:</span>  <span class=mi>30</span><span class=p>,</span>
	<span class=mi>7</span><span class=p>:</span>  <span class=mi>31</span><span class=p>,</span>
	<span class=mi>8</span><span class=p>:</span>  <span class=mi>31</span><span class=p>,</span>
	<span class=mi>9</span><span class=p>:</span>  <span class=mi>30</span><span class=p>,</span>
	<span class=mi>10</span><span class=p>:</span> <span class=mi>31</span><span class=p>,</span>
	<span class=mi>11</span><span class=p>:</span> <span class=mi>30</span><span class=p>,</span>
	<span class=mi>12</span><span class=p>:</span> <span class=mi>31</span><span class=p>,</span>
<span class=p>}</span>

<span class=c1>// input time without centry.
</span><span class=c1></span><span class=kd>func</span> <span class=nf>validateTime</span><span class=p>(</span><span class=nx>time</span> <span class=p>[]</span><span class=kt>byte</span><span class=p>)</span> <span class=kt>bool</span> <span class=p>{</span>
	<span class=nx>length</span> <span class=o>:=</span> <span class=nb>len</span><span class=p>(</span><span class=nx>time</span><span class=p>)</span>

	<span class=nx>date</span> <span class=o>:=</span> <span class=nf>charsToDigit</span><span class=p>(</span><span class=nx>time</span><span class=p>[</span><span class=nx>length</span><span class=o>-</span><span class=mi>2</span> <span class=p>:</span> <span class=nx>length</span><span class=p>])</span>
	<span class=nx>month</span> <span class=o>:=</span> <span class=nf>charsToDigit</span><span class=p>(</span><span class=nx>time</span><span class=p>[</span><span class=nx>length</span><span class=o>-</span><span class=mi>4</span> <span class=p>:</span> <span class=nx>length</span><span class=o>-</span><span class=mi>2</span><span class=p>])</span>

	<span class=k>if</span> <span class=nx>month</span> <span class=o>!=</span> <span class=mi>2</span> <span class=p>{</span>
		<span class=nx>days</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>monthDays</span><span class=p>[</span><span class=nx>month</span><span class=p>]</span>
		<span class=k>if</span> <span class=p>!</span><span class=nx>ok</span> <span class=p>{</span>
			<span class=k>return</span> <span class=kc>false</span>
		<span class=p>}</span>
		<span class=k>return</span> <span class=nx>date</span> <span class=o>&lt;=</span> <span class=nx>days</span>
	<span class=p>}</span>

	<span class=nx>year</span> <span class=o>:=</span> <span class=nf>charsToDigit</span><span class=p>(</span><span class=nx>time</span><span class=p>[:</span><span class=nx>length</span><span class=o>-</span><span class=mi>4</span><span class=p>])</span>

	<span class=nx>leapYear</span> <span class=o>:=</span> <span class=nx>year</span><span class=o>%</span><span class=mi>4</span> <span class=o>==</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=nx>year</span><span class=o>%</span><span class=mi>100</span> <span class=o>!=</span> <span class=mi>0</span> <span class=o>||</span> <span class=nx>year</span><span class=o>%</span><span class=mi>400</span> <span class=o>==</span> <span class=mi>0</span>

	<span class=k>if</span> <span class=nx>leapYear</span> <span class=p>{</span>
		<span class=k>return</span> <span class=nx>date</span> <span class=o>&lt;=</span> <span class=mi>29</span>
	<span class=p>}</span>
	<span class=k>return</span> <span class=nx>date</span> <span class=o>&lt;=</span> <span class=mi>28</span>
<span class=p>}</span>

<span class=c1>// Valid will validate Swedish social security numbers.
</span><span class=c1></span><span class=kd>func</span> <span class=nf>Valid</span><span class=p>(</span><span class=nx>i</span> <span class=kd>interface</span><span class=p>{})</span> <span class=kt>bool</span> <span class=p>{</span>
	<span class=k>switch</span> <span class=nx>v</span> <span class=o>:=</span> <span class=nx>i</span><span class=p>.(</span><span class=kd>type</span><span class=p>)</span> <span class=p>{</span>
	<span class=k>case</span> <span class=kt>int</span><span class=p>,</span> <span class=kt>int32</span><span class=p>,</span> <span class=kt>int64</span><span class=p>,</span> <span class=kt>uint</span><span class=p>,</span> <span class=kt>uint32</span><span class=p>,</span> <span class=kt>uint64</span><span class=p>:</span>
		<span class=k>return</span> <span class=nf>ValidString</span><span class=p>(</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprint</span><span class=p>(</span><span class=nx>v</span><span class=p>))</span>
	<span class=k>case</span> <span class=kt>string</span><span class=p>:</span>
		<span class=k>return</span> <span class=nf>ValidString</span><span class=p>(</span><span class=nx>v</span><span class=p>)</span>
	<span class=k>default</span><span class=p>:</span>
		<span class=k>return</span> <span class=kc>false</span>
	<span class=p>}</span>
<span class=p>}</span>

<span class=kd>var</span> <span class=nx>rule3</span> <span class=p>=</span> <span class=p>[</span><span class=o>...</span><span class=p>]</span><span class=kt>int</span><span class=p>{</span><span class=mi>0</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>4</span><span class=p>,</span> <span class=mi>6</span><span class=p>,</span> <span class=mi>8</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>5</span><span class=p>,</span> <span class=mi>7</span><span class=p>,</span> <span class=mi>9</span><span class=p>}</span>

<span class=c1>// luhn will test if the given string is a valid luhn string.
</span><span class=c1></span><span class=kd>func</span> <span class=nf>luhn</span><span class=p>(</span><span class=nx>s</span> <span class=p>[]</span><span class=kt>byte</span><span class=p>)</span> <span class=kt>bool</span> <span class=p>{</span>
	<span class=nx>odd</span> <span class=o>:=</span> <span class=nb>len</span><span class=p>(</span><span class=nx>s</span><span class=p>)</span> <span class=o>&amp;</span> <span class=mi>1</span>

	<span class=kd>var</span> <span class=nx>sum</span> <span class=kt>int</span>

	<span class=k>for</span> <span class=nx>i</span><span class=p>,</span> <span class=nx>c</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>s</span> <span class=p>{</span>
		<span class=k>if</span> <span class=nx>i</span><span class=o>&amp;</span><span class=mi>1</span> <span class=o>==</span> <span class=nx>odd</span> <span class=p>{</span>
			<span class=nx>sum</span> <span class=o>+=</span> <span class=nx>rule3</span><span class=p>[</span><span class=nx>c</span><span class=o>-</span><span class=sc>&#39;0&#39;</span><span class=p>]</span>
		<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
			<span class=nx>sum</span> <span class=o>+=</span> <span class=nb>int</span><span class=p>(</span><span class=nx>c</span> <span class=o>-</span> <span class=sc>&#39;0&#39;</span><span class=p>)</span>
		<span class=p>}</span>
	<span class=p>}</span>

	<span class=k>return</span> <span class=nx>sum</span><span class=o>%</span><span class=mi>10</span> <span class=o>==</span> <span class=mi>0</span>
<span class=p>}</span>

<span class=c1>// getCoOrdinationDay will return co-ordination day.
</span><span class=c1></span><span class=kd>func</span> <span class=nf>getCoOrdinationDay</span><span class=p>(</span><span class=nx>day</span> <span class=p>[]</span><span class=kt>byte</span><span class=p>)</span> <span class=p>[]</span><span class=kt>byte</span> <span class=p>{</span>
	<span class=nx>d</span> <span class=o>:=</span> <span class=nf>charsToDigit</span><span class=p>(</span><span class=nx>day</span><span class=p>)</span>
	<span class=k>if</span> <span class=nx>d</span> <span class=p>&lt;</span> <span class=mi>60</span> <span class=p>{</span>
		<span class=k>return</span> <span class=nx>day</span>
	<span class=p>}</span>

	<span class=nx>d</span> <span class=o>-=</span> <span class=mi>60</span>

	<span class=k>if</span> <span class=nx>d</span> <span class=p>&lt;</span> <span class=mi>10</span> <span class=p>{</span>
		<span class=k>return</span> <span class=p>[]</span><span class=kt>byte</span><span class=p>{</span><span class=sc>&#39;0&#39;</span><span class=p>,</span> <span class=nb>byte</span><span class=p>(</span><span class=nx>d</span><span class=p>)</span> <span class=o>+</span> <span class=sc>&#39;0&#39;</span><span class=p>}</span>
	<span class=p>}</span>

	<span class=k>return</span> <span class=p>[]</span><span class=kt>byte</span><span class=p>{</span>
		<span class=nb>byte</span><span class=p>(</span><span class=nx>d</span><span class=p>)</span><span class=o>/</span><span class=mi>10</span> <span class=o>+</span> <span class=sc>&#39;0&#39;</span><span class=p>,</span>
		<span class=nb>byte</span><span class=p>(</span><span class=nx>d</span><span class=p>)</span><span class=o>%</span><span class=mi>10</span> <span class=o>+</span> <span class=sc>&#39;0&#39;</span><span class=p>,</span>
	<span class=p>}</span>
<span class=p>}</span>

<span class=c1>// charsToDigit converts char bytes to a digit
</span><span class=c1>// example: [&#39;1&#39;, &#39;1&#39;] =&gt; 11
</span><span class=c1></span><span class=kd>func</span> <span class=nf>charsToDigit</span><span class=p>(</span><span class=nx>chars</span> <span class=p>[]</span><span class=kt>byte</span><span class=p>)</span> <span class=kt>int</span> <span class=p>{</span>
	<span class=nx>l</span> <span class=o>:=</span> <span class=nb>len</span><span class=p>(</span><span class=nx>chars</span><span class=p>)</span>
	<span class=nx>r</span> <span class=o>:=</span> <span class=mi>0</span>
	<span class=k>for</span> <span class=nx>i</span><span class=p>,</span> <span class=nx>c</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>chars</span> <span class=p>{</span>
		<span class=nx>p</span> <span class=o>:=</span> <span class=nb>int</span><span class=p>((</span><span class=nx>c</span> <span class=o>-</span> <span class=sc>&#39;0&#39;</span><span class=p>))</span>
		<span class=k>for</span> <span class=nx>j</span> <span class=o>:=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>j</span> <span class=p>&lt;</span> <span class=nx>l</span><span class=o>-</span><span class=nx>i</span><span class=o>-</span><span class=mi>1</span><span class=p>;</span> <span class=nx>j</span><span class=o>++</span> <span class=p>{</span>
			<span class=nx>p</span> <span class=o>*=</span> <span class=mi>10</span>
		<span class=p>}</span>
		<span class=nx>r</span> <span class=o>+=</span> <span class=nx>p</span>
	<span class=p>}</span>
	<span class=k>return</span> <span class=nx>r</span>
<span class=p>}</span>
</code></pre></div><p>Final result:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>$ go <span class=nb>test</span> -bench<span class=o>=</span>BenchmarkValid$ -benchmem
goos: darwin
goarch: amd64
pkg: github.com/ngalayko/go
BenchmarkValid-4  <span class=m>20000000</span>  94.0 ns/op  <span class=m>16</span> B/op  <span class=m>1</span> allocs/op
PASS
</code></pre></div><p><img src=./optimization-n.png alt=Optimizaion-N></p><p><img src=./optimization-bytes.png alt=Optimizaion-bytes></p><p><img src=./optimization-allocs.png alt=Optimizaion-allocs></p><p><img src=./optimization-ns.png alt=Optimizaion-ns></p><p>If you have an idea how to improve it more, please share.</p></article></main><footer id=footer><style>a{color:inherit;text-decoration:none}a:hover{text-decoration:underline}</style>&copy; 2018...2021
<a href=https://galaiko.rocks>Nikita Galaiko</a>
&#183; <a href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank rel=noopener>CC BY-NC 4.0</a></footer></body></html>
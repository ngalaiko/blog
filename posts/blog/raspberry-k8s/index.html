<!doctype html><html><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Nikita Galaiko"><title>Raspberry Pi: K8s cluster</title><link rel="shortcut icon" href=https://galaiko.rocks/favicon.ico><style>*,*:before,*:after{box-sizing:border-box}body{font-size:20px;line-height:28px;font-family:helvetica neue,arial,sans-serif;width:100%;margin:0 auto;padding:0 16px}@media(min-width:770px){body{width:800px}}header#banner{margin:25px 0}header#banner a{text-decoration:none}header#banner a:hover{text-decoration:underline}header#banner h2{display:inline;margin:0 8px 0 0;font-size:1em}header#banner nav{display:inline-block}header#banner nav ul{list-style-type:none;text-transform:lowercase;margin:0;padding:0}header#banner nav ul li{display:inline;margin:0 3px}main#content a{text-decoration:none}main#content a:hover{text-decoration:underline}main#content h1,main#content h2,main#content h3,main#content h4,main#content h5,main#content h6{margin-bottom:0}main#content h2{font-size:21.4px;line-height:28px;margin:28px 0 0}main#content h1+p,main#content h3+p,main#content h4+p,main#content h5+p,main#content h6+p{margin-top:5px}main#content p{margin:16px 0}main#content hr{height:1px;border:0}main#content ul#posts{list-style-type:none;margin-top:0;padding:0}main#content ul#posts li{margin:5px 0;padding:0}main#content ul#posts small{font-size:.8em;margin-left:10px}main#content ul#posts li a{text-decoration:none}main#content header#post-header h1{display:block;font-size:1.95552em;line-height:1.2141em}main#content header#post-header div{display:block;font-size:.7em;line-height:.9em}main#content img{max-width:100%;margin:0 auto}main#content figure{margin:16px 0}main#content figure img{display:block;max-width:100%;margin:0 auto}main#content figure figcaption{font-size:.92em;font-style:italic;line-height:22px;text-align:center;margin-top:6px;padding:0 10px}main#content figure figcaption h4{font-style:normal;display:inline;margin:0}main#content figure figcaption p{display:inline;margin:0;padding-left:8px}main#content blockquote{font-style:italic;margin-top:10px;margin-bottom:10px;margin-left:50px;padding-left:15px;border-left:3px solid #ccc}main#content code,main#content pre{font-family:menlo,monospace}main#content code{font-size:.87em;line-height:1.45em}main#content pre{display:block;overflow-x:auto;white-space:pre}main#content section.footnotes{font-size:.9em}footer#footer{margin:40px 0;font-size:.8em;font-weight:300}html{scrollbar-color:#6c6c6c #2e2e2e}body{color:#282828;background:#fbf1c7}header#banner a{color:#282828}header#banner nav ul li a{color:#504945}main#content a{color:#076678}main#content p{color:#3c3836}main#content hr{background:#d8d8d8}main#content ul#posts small{color:#7c6f64}main#content ul#posts li a:hover{color:#458588}main#content header#post-header div{color:#7c6f64}@media(prefers-color-scheme:dark){html{scrollbar-color:#6c6c6c #2e2e2e}body{color:#fbf1c7;background:#282828}header#banner a{color:#fbf1c7}header#banner nav ul li a{color:#d5c4a1}main#content a{color:#83a598}main#content p{color:#ebdbb2}main#content hr{background:#5c5c5c}main#content ul#posts small{color:#a89984}main#content ul#posts li a:hover{color:#458588}main#content header#post-header div{color:#a89984}}</style></head><body><header id=banner><h2><a href=https://galaiko.rocks>Nikita Galaiko</a></h2><nav><ul><li><a href=/posts/ title>Posts</a></li><li><a href=/about/ title>About</a></li><li><a href=/posts/index.xml title>RSS</a></li></ul></nav></header><main id=content><article><header id=post-header><h1>Raspberry Pi: K8s cluster</h1><div><time>June 24, 2019</time></div></header><p>I spent too much time configuring Kubernetes cluster on Raspberry Pi today, so here are notes for my future
self on how to do that:</p><h2 id=sd-card>SD card</h2><ul><li><p>Download operation system.</p><p>I am using <a href=https://github.com/hypriot/image-builder-rpi/releases/download/v1.10.0/hypriotos-rpi-v1.10.0.img.zip>HypriotOS v1.10.0</a>
It is based on <strong>Raspbian Buster Lite</strong>, has a preinstalled docker and some other minor things
to simplify cluster setup:</p><pre><code>  $ uname -a 
  Linux node-red 4.14.98-v7+ #1200 SMP Tue Feb 12 20:27:48 GMT 2019 armv7l GNU/Linux
  $ docker version
  Client:
   Version:           18.06.3-ce
   API version:       1.38
   Go version:        go1.10.3
   Git commit:        d7080c1
   Built:             Wed Feb 20 02:42:54 2019
   OS/Arch:           linux/arm
   Experimental:      false

  Server:
   Engine:
   Version:          18.06.3-ce
   API version:      1.38 (minimum version 1.12)
   Go version:       go1.10.3
   Git commit:       d7080c1
   Built:            Wed Feb 20 02:38:25 2019
   OS/Arch:          linux/arm
   Experimental:     false
</code></pre></li><li><p>Flash it to SD cards using <a href=https://github.com/hypriot/flash/releases>flash</a></p><p>Don&rsquo;t forget to define a hostname. It will save you some time later.</p><pre><code>  $ flash -n node-red ./Downloads/hypriotos-rpi-v1.10.0.img
</code></pre></li><li><p>Provision all nodes you have like this and boot them up.</p></li><li><p>Install Kubernetes on <strong>all</strong> nodes.</p><p>Note the version here: <code>1.13.5</code>. Because of changes in <code>1.14.0</code>, Kubernetes requires enabled pids
cgroup. But kernels before <code>4.19.46-v7+</code> do not support it. If you are reading this after some
time, it should be fixed, and the latest version of Kubernetes might work just fine.</p><pre><code>  $ curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo apt-key add - &amp;&amp; \
   echo &quot;deb http://apt.kubernetes.io/ kubernetes-xenial main&quot; | sudo tee /etc/apt/sources.list.d/kubernetes.list &amp;&amp; \
   sudo apt-get update -q &amp;&amp; \
   sudo apt-get install -qy kubeadm=1.13.5 kubectl=1.13.5 kubelet=1.13.5
</code></pre></li><li><p>Initialize Kubernetes on the <strong>master</strong> node:</p><pre><code>$ sudo kubeadm init
</code></pre><p>Notice <code>sudo</code> here. For some reason, if you do it as <code>root</code>, it can fail with an error (couldn&rsquo;t
find what the error was :( )</p><p>If all goes fine, you will see an output similar to:</p><pre><code>...
Your Kubernetes master has initialized successfully!
To start using your cluster, you need to run the following as a regular user:
  mkdir -p $HOME/.kube
  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
  sudo chown $(id -u):$(id -g) $HOME/.kube/config
  You should now deploy a pod network to the cluster.
Run &quot;kubectl apply -f [podnetwork].yaml&quot; with one of the options listed at:
  https://kubernetes.io/docs/concepts/cluster-administration/addons/
You can now join any number of machines by running the following on each node
as root:
  kubeadm join --token TOKEN 192.168.1.100:6443 --discovery-token-ca-cert-hash HASH
</code></pre><pre><code>
</code></pre></li><li><p>Do what the output says:</p><pre><code>$ sudo cp /etc/kubernetes/admin.conf $HOME/
$ sudo chown $(id -u):$(id -g) $HOME/admin.conf
$ export KUBECONFIG=$HOME/admin.conf
</code></pre><pre><code> Now you should be able to list all nodes. There is a single __NotReady__ __master__ 
 node at this point:
</code></pre><pre><code> $ kubectl get nodes
 NAME         STATUS     ROLES    AGE   VERSION
 node-red     NotReady   master   17m   v1.13.5
</code></pre><pre><code>
</code></pre></li><li><p>Add other nodes to the cluster.</p><pre><code>$ sudo kubeadm join --token TOKEN 192.168.1.100:6443 --discovery-token-ca-cert-hash HASH
</code></pre><p>Notice <code>sudo</code> again.</p></li><li><p>Now, you should be able to see all nodes from the master node:</p><pre><code>$ kubectl get nodes
NAME         STATUS     ROLES    AGE    VERSION
node-black   NotReady   &lt;none&gt;   106m   v1.13.5
node-blue    NotReady   &lt;none&gt;   105m   v1.13.5
node-green   NotReady   &lt;none&gt;   105m   v1.13.5
node-red     NotReady   master   110m   v1.13.5
</code></pre></li><li><p>Deploy container network from the <strong>master</strong> node.</p><pre><code>$ kubectl apply -f &quot;https://cloud.weave.works/k8s/net?k8s-version=1.13.5&quot;
</code></pre></li><li><p>After some time, all nodes should be ready.</p><pre><code>$ kubectl get nodes
NAME         STATUS     ROLES    AGE    VERSION
node-black   Ready     &lt;none&gt;   106m   v1.13.5
node-blue    Ready     &lt;none&gt;   105m   v1.13.5
node-green   Ready     &lt;none&gt;   105m   v1.13.5
node-red     Ready     master   110m   v1.13.5
</code></pre></li></ul><h1 id=links>Links</h1><ul><li><a href=https://blog.hypriot.com/post/setup-kubernetes-raspberry-pi-cluster/>https://blog.hypriot.com/post/setup-kubernetes-raspberry-pi-cluster/</a></li><li><a href=https://kubecloud.io/setting-up-a-kubernetes-1-11-raspberry-pi-cluster-using-kubeadm-952bbda329c8>https://kubecloud.io/setting-up-a-kubernetes-1-11-raspberry-pi-cluster-using-kubeadm-952bbda329c8</a></li><li><a href=https://github.com/hypriot/flash>https://github.com/hypriot/flash</a></li><li><a href=https://github.com/teamserverless/k8s-on-raspbian/issues/16>https://github.com/teamserverless/k8s-on-raspbian/issues/16</a></li></ul></article></main><footer id=footer><style>a{color:inherit;text-decoration:none}a:hover{text-decoration:underline}</style>&copy; 2018...2021
<a href=https://galaiko.rocks>Nikita Galaiko</a>
&#183; <a href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank rel=noopener>CC BY-NC 4.0</a></footer></body></html>